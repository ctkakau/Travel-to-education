---
title: "Travel to work and education"
subtitle: "Comparing 'travel to work' and 'travel to education' census data for 2018 and 2023"
author: 'Chad Kakau: 300212228'
date: "`r Sys.Date()`"
always_allow_html: true
output:
  
  bookdown::html_document2:
    fig_caption: yes
    toc: false
  bookdown::pdf_document2:
    toc: false
---

\newpage
\tableofcontents
\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE,
                      include = FALSE, 
                      error = FALSE, 
                      warning = FALSE,
                      fig.dim = c(8, 4),
                      fig.pos = "h")

library(httr2)
library(plotly)
library(dplyr) # try without importing library and create functions to use
library(tidyr) # separate_wider_delim, pivot_longer, pivot_wider
library(purrr)
library(xml2)
library(ggplot2)
library(cowplot) # plot_grid
library(stringr) # only used for one function
library(readr) # only used for one function "read_csv(col_types) = 'cccccc")
library(knitr) # kable
library(ggbump)


api_ade_auth_key <- "5dc60d5341c3446690edc70c8bdf67ab"
stats_shapefiles_key <- "92c010068afb47089f76501613231717" 
```

```{r base_path, echo=FALSE, include=FALSE}
base_path <- request("https://apis.stats.govt.nz/ade-api/rest") %>%
  req_headers(
    `Ocp-Apim-Subscription-Key`= api_ade_auth_key,
    .redact = "Ocp-Apim-Subscription-Key",
    `Cache-Control` = 'no-cache',
    `accept-encoding` = 'identity'
  )
```

```{r fn_extract_dimensions}
# function to extract dimensions 
extract_dimensions <- function(resp){
  
  # retrieve Travel to Education dimension names
  dims <- resp |>
    pluck("Structure", "Structures", "Codelists") |>
    purrr::map_dfr(
      \(x) {
        tibble(
          CL =  x |> attr("id") |> strsplit(split = "CL_") |> pluck(1, 2),  
          dimension = x |>  pluck("Name", 1))}) 
  
  # extract code and decodes for levels in Travel to Education dimensions
  tables <- map(resp$Structure$Structures$Codelists,
                   \(x) {purrr::map_dfr(x,\(y) {
                           list(
                             level = y |> pluck("Name", 1),
                             code = y |>  attr("id"))})})
                              
  # rename tables to dimensions
  names(tables) <- dims$dimension

return(list(dimensions = dims, structure = tables))
}
```


```{r fn_info_about_data}
# function to retrieve information about data
ade_api_info_about_data <- function(resourceId = "CEN23_TRA_001") {  
  
  # set parameters
  flowRef <- resourceId
  key <- "all"
  
  # construct request
  req <- base_path |>
    req_url_path_append("availableconstraint") |>
    req_url_path_append(flowRef) |>
    req_url_path_append(key) |>
    req_url_query(
      mode = "exact",
      references = "codelist")
  
  # preview the request
  # req_dry_run(req)
  
  # perform request
  resp <- req_perform(req) 
  
  data <- resp |>
  resp_body_xml() |>
  as_list()
  
  data_dimensions <- extract_dimensions(data)
  
  return(data_dimensions)
  
}
```


```{r fn_ade_api_data_by_key}
# function for retrieving data
ade_api_data_by_key <- function(key, resourceId = "CEN23_TRA_001") {
  
  # request "information about data" from ADE-API
  struc <- ade_api_info_about_data(resourceId = resourceId)
  
  # create parameters for data query
  flowRef <- paste('STATSNZ', resourceId ,'1.0', sep = ",") 
  key <- key

  req <- base_path |>
    req_url_path_append('data') |>  
    req_url_path_append(flowRef) |>
    req_url_path_append(key) |>
    req_url_query(
      format = 'csv',
      detail = "full"
    )
  
  # send the request and save the response
  resp <- req_perform(req)
  
  # convert the response to something readable
  data <- resp |>
    resp_body_string() |>
    readr::read_csv(col_types = "cccccc") #|>
  
  
  # remove first (DATAFLOW) and last (OBS_STATUS) columns
  data_length <- length(names(data))
  data <- data |> select(-1, -data_length)
  
  # create vector of shortened names for columns
  nms <- names(data) |> tibble() |> tidyr::separate_wider_delim(
    cols = "names(data)",
    delim = "_",
    names = c(NA, "dim", NA),
    too_few = "align_start",
    too_many= "drop"
    )
  
  # update names of data frame
  names(data) <- nms[[1]]
  
  # sort column names in alphabetical order to match data output
  no_val <- nms[[1]][-(data_length-2)]
  sorted_nms <- order(no_val, decreasing = F, method="auto")
  
  # reorder columns in data frame
  data <- data |>
    select(
      sorted_nms, 
      VALUE
     )
  # create df for merging data
  df <- map2(data[,1:5],
     struc$structure,
     \(x, y){
       # create a tibble to give a colname for referencing in inner_join
       x <- tibble(xname=x)
       # merge columns
       inner_join(x, y, by = join_by(xname == y$code))|>
    # retain text description
    select(level)
     }) |>
    # lift nested list
    purrr::map_dfr(\(x) x |> pluck(1)) 
  
  
  # re-attach observed values
  df <- cbind(df, data[,6])
  
  return(df)

}

```

```{r fn_retrieve_api_codes}

retrieve_api_codes <- function(df, pattern, excl = NULL, lvl = level, digits = FALSE){
  
  out <- df %>%
    dplyr::filter(str_detect({{lvl}}, pattern)) 
  
  # remove exclusions
  if (!is.null(excl)) {
    out <- out %>% filter(!str_detect({{lvl}}, excl))
  }
  
  # limit to required length
  if (digits) {
    out <- out %>% filter(str_length(code) == digits)
  }
  
  # collapse code output
  out <- out %>%
    select(code) %>%
    unlist() %>%
    paste(collapse = "+")
  
  return(out)
}
```


```{r fn_shorter_modes}
# function to reduce length of location names and modes of travel
shorter_modes <- function (df, akl = F){
  if (akl){
    df <- df|> mutate(
  Location = str_remove(Location, " Region")
  )
    } else {
    df <- df|> mutate(
  Location = str_remove(Location, " Local Board Area")
    )
    } 
  df <- df |>
    mutate(
  Travel_mode = case_when(
    str_detect(Travel_mode, "asseng") ~ "Passenger",
    str_detect(Travel_mode, "ome") ~ "At home",
    str_detect(Travel_mode, "rive a com") ~ "Company vehicle",
    str_detect(Travel_mode, "rive a ca|rive a pri") ~ "Private vehicle",
    str_detect(Travel_mode, "Did not go") ~ "No work",
    
    TRUE ~ Travel_mode)
)
  return(df)
}
shorter_modes(abe, T)
```

```{r fn_prop_bar}
# create ggplot
prop_bar <- function(df, df_lab, x, x_lab, fill, fill_lab){
  df <- df |> 
    group_by(Location, Travel_mode) |> 
    summarise(Value = sum(Value, na.rm = T),
              .groups = "keep")
  
  plt <- ggplot(data = df) +
    geom_bar(position = "fill",
             stat = "identity",
             aes(y = Value, 
                 x = {{x}},
                 fill = {{fill}})
             ) +
    labs(title = paste(fill_lab, df_lab, "by", x_lab)) +
    ylab("Proportion") +
    coord_flip()
  
  return(plt)
}
```


```{r fn_wrapped_regions}
# use facet grid to view all modes of travel to education
wrapped_regions <- function(df, suppress_legend = FALSE) {

  # summarise Values
  df <- df |>
    group_by(Location, Travel_mode) |> # Location -> {{column}}
    summarise(Value = sum(Value, na.rm = T),
              .groups = "keep")

  # create plot
  plt <- ggplot(data = df,
       aes(fill = Travel_mode,
           y = Value,
           x = Travel_mode)
       ) +
  geom_col(
    position = "dodge",
    stat = "summary",
    fun = sum
    ) +
  facet_wrap(~Location) +
  scale_y_continuous(labels = function(x) paste(x/1000, "K")) +
  theme(
    legend.position = {if (suppress_legend) "none" else "right"},
    axis.text.x = element_blank()
    )

  return(plt)
}
```

```{r fn_wrapped}
# use facet grid to view all modes of travel to education
wrapped <- function(df, column, year = TRUE, suppress_legend = FALSE) {
  
  # summarise Values
  df <- df |> 
    group_by({{column}}, Travel_mode, Year) |> 
    summarise(Value = sum(Value, na.rm = T),
                        .groups = "keep")
  # create plot
  plt <- ggplot(data = df,  
       aes(fill = Travel_mode,
           y = Value,
           x = Travel_mode)
       ) +
  geom_col(
    position = "dodge",
    stat = "identity",
    ) +
    # switch facet based on "year" or "region
  scale_y_continuous(labels = function(x) paste(x/1000, "K")) +
  theme(
    legend.position = {if (suppress_legend) "none" else "right"}, 
    axis.text.x = element_blank(),
    )
  if (year){
    plt <- plt + facet_grid(cols =vars({{column}}), rows = vars(Year)) 
  } else {
    plt <- plt + facet_wrap(vars({{column}}))
  }
  return(plt)
}
```


```{r}
changes <- function(df, column, pct = F){
  
  # transform data to summarise
  df <- df |> 
      # use switch for column
      group_by({{column}}, Travel_mode, Year) |> 
      summarise(Value = sum(Value, na.rm =T),
                .groups = "keep") |>
      pivot_wider(id_cols = c({{column}}, Travel_mode), 
                  names_from = Year,
                  values_from = Value) 
      
    # switch for percentage/total "pct"
    if(pct){
      
      labels_ <- function(x) paste(x*100, "%", sep = "")
      ylab_ <- "% change 2018 to 2023"
      df <- df |>
        mutate(difference = (`2023`-`2018`)/`2018`)
      
    } else {
      
      labels_ <- function(x) paste(x/1000, "K", sep = "")
      ylab_ <- "total change 2018 to 2023"
      df <- df |>
        mutate(difference = `2023`-`2018`)
    }
    
    # create plot
    plt <- ggplot(data = df, aes(x = Travel_mode)) +
      geom_point(
        shape = 21,
        aes(y = 0),
        colour = "orange"
      ) + 
      geom_point(
        aes(
          y= difference, 
            colour = Travel_mode),
        ) +
      geom_segment(
        aes(
          xend = Travel_mode,
          y = 0,
          yend= difference,
          colour = Travel_mode),
        ) +
      labs(
        y = ylab_
      ) +
      scale_y_continuous(labels = labels_) +
      theme(axis.text.x = element_blank())+
      facet_grid(cols = vars({{column}}), 
      )
    
    return(plt)
}
```

```{r fn_ranked_travel_modes}
ranked_travel_modes <- function(df, column, labels = c("education", "age")){
  library(ggbump)

  # transform data to rank by Value within age and travel_mode
  df <- df |>
    group_by({{column}}, Travel_mode) |>
    summarise(Value = sum(Value, na.rm=T), .groups = "keep" ) |>
    arrange({{column}}, desc(Value)) 
  
  # switch based on labels[2]
  if (labels[2] == "age") {
  df <- df |>
    group_by(Age) |>
    mutate(
      Age = Age |> str_split_i("-| years and", i=1) |> as.numeric(),
      Rank = order(Value, decreasing = T))
    
  break_labs <- seq(0, 90, 5)
  n_breaks <- length(break_labs)
  
  
  bump <- ggplot(data = df,
                 aes(x = Age, y = Rank, colour = Travel_mode))+
    scale_x_continuous(breaks = break_labs)
  } else {
    df <- df |>
      ungroup() |>
    mutate(
      Loc = {{column}} |> factor() |> as.numeric()
    ) |> 
    group_by({{column}}) |>
    mutate(Rank = order(Value, decreasing = T))
    
    n_breaks <- length(unique(df$Location))
    break_labs <- unique(df$Location)  
    
    bump <- ggplot(data = df,
                   aes(x = Loc, y = Rank, colour = Travel_mode)) +
      theme(axis.text.x = element_text(angle = 30, vjust=0.8, hjust=0.8)) +
    scale_x_continuous(breaks = 1:n_breaks, labels = break_labs)
  }
  
  # generate ggplot object
  bump <- bump + 
    geom_bump() +
    geom_point(aes(size = Value))+
    # include variables: df_lab, var_lab (i.e. "age" or "region")
    labs(title = paste("Preferred modes of travel to",labels[1],"by", labels[2]),
         y = "Rank")  +
    scale_y_continuous(breaks = 1:10, labels = 1:10) 
    
return(bump)
}
```

```{r fn_htmlify}
# function to create plots as interactive when generating html output
htmlify <- function(plot){
  if (knitr::is_html_output()) ggplotly(plot) else plot
}
```

```{r key_tee}
# retrieve information about the totals by topic so we can set up filters for future queries
tee_dims <- ade_api_info_about_data(resourceId = "CEN23_TRA_001") # this for everything

# all_dims$dimensions # includes Area, Variable codes, Census Year, can be used to filter to key variables and codes
# e.g. all_dims$structure$Area |> filter(str_detect(level, "Region")), will filter Areas that contain "Region"
rgn <- retrieve_api_codes(tee_dims$structure$`Educational institution address`,
                          pattern = "Region",
                          excl = "ceani|nlet|sland|orther|entra|utsi",
                          digits = 2,
                          lvl = level)


# modes of travel: to education begins 0 and has three digits
tvl <- retrieve_api_codes(tee_dims$structure$`Main means of travel to education`,
                          pattern = "^0",
                          digits = 3,
                          lvl = code)

# age groups: code begins with "0" or "1" and has total 2 digits - results in 5 year age groups
age <- retrieve_api_codes(tee_dims$structure$Age,
                          pattern = "^0|^1",
                          lvl = code,
                          digits = 2)
  
# gender groups: contains 1, 2, 3 results in Male Female Another
gen <- retrieve_api_codes(tee_dims$structure$Gender,
                          pattern = "[123]",
                          lvl = code)
  
# years ... just fill this one in directly
year <- "2018+2023" # all years


# travel to work has different travel modes
two_dims <- ade_api_info_about_data(resourceId = "CEN23_TRA_003")
two_tvl <- retrieve_api_codes(two_dims$structure$`Main means of travel to work`,
                              pattern = "^0",
                              digits = 3,
                              lvl = code)

# Territorial Authorities within Auckland are labelled "Auckland Local Board"
akb <- retrieve_api_codes(tee_dims$structure$`Educational institution address`,
                          pattern = "Local Board",
                          )

# combine all codes for output
tee_key <- paste(year, rgn, tvl, age, gen, sep=".")
two_key <- paste(year, rgn, two_tvl, age, gen, sep=".")
abe_key <- paste(year, akb, tvl, age, gen, sep=".")
abo_key <- paste(year, akb, two_tvl, age, gen, sep=".")

# clean the environment
rm(list = c("tee_dims", "two_dims", "two_tvl"))

```

```{r data_by_key_tee_and_two}
# extract data by key for main means of travel to education
if (!exists("tee")) {
  tee <- ade_api_data_by_key(key = tee_key, resourceId = "CEN23_TRA_001")
  # rename columns for consistency
  names(tee) <- c("Age", "Location", "Gender", "Travel_mode", "Year", "Value") #AGE EDU GEN TED YEAR VALUE
  tee <- shorter_modes(tee)
  
  abe <- ade_api_data_by_key(key = abe_key, resourceId = "CEN23_TRA_001")
  # rename columns for consistency
  names(abe) <- c("Age", "Location", "Gender", "Travel_mode", "Year", "Value") #AGE EDU GEN TED YEAR VALUE
  abe <- shorter_modes(abe)
}

# extract corresponding data by key for main means of travel to work
if (!exists("two")) {
  two <- ade_api_data_by_key(key = two_key, resourceId = "CEN23_TRA_003")
  # rename columns for consistency 
  names(two)<- c("Age", "Gender", "Travel_mode", "Location", "Year", "Value")#AGE GEN TWO WOA YEAR VALUE
  two <- shorter_modes(two)
  
  abo <- ade_api_data_by_key(key = abo_key, resourceId = "CEN23_TRA_001")
  # rename columns for consistency
  names(abo) <- c("Age", "Location", "Gender", "Travel_mode", "Year", "Value") #AGE EDU GEN TED YEAR VALUE
  abo <- shorter_modes(abo)
}
```

# Introduction  

This document provides analysis of Statistics New Zealand's transport related census data, focussing on two questions in the census:  

  - What was your main means of travel to education? and 
  - What was your main means of travel to work.
  
Methods of travel to work have long been of interest as having both cause and effect roles in estimating economic performance.  Since 2018, the "travel to education" question has been included in the census as a means of quantifying the effect of education on the transport sector.  This analysis will review the census responses for these two transport-related questions...

# Document layout  

This document begins by introducing some considerations about the nature and quality of census data before moving into exploratory analysis procedures:  

  - Data descriptions 
  - Basic visualisations
  - Modelling relationships and associations

# upfront findings section  

This section should include a summary of key findings

# Considerations for the reader  

Prior to conducting analysis, it is worth noting three observations/facts:

  - Although census data can be seen as a population-level survey, the questions are tightly contextualised, and for the purposes of the questions of interest in this document, responses must be viewed as a snapshot in time, taken on the day of the census;
  - Census data includes populations of interest, that is, not every question relates to every respondent.  For example, questions about time since arriving in New Zealand will only be relevant for people who have arrived from overseas.  Similarly, responses for driving to place of education don't make sense for people aged less than 15 years, since a person must be 16 years or older to legally drive in New Zealand.
  - Census questions and categories can change over time and that can make time-series comparisons difficult or impossible.  For instance, the "travel to education" question was introduced in 2018 meaning the only data available is for 2018 and 2023.  Similarly, the gender grouping "Another gender / He ira kē anō" was introduced in 2023 and can't be compared to data from an earlier census.  


## Further constraints of the data  

Statistics New Zealand has released census data in a variety of structures, including:  

  - Main means of travel to work by place of work
  - Main means of travel to education by address of educational institution  

These data should be viewed as relating to the destination of travel, that is the responses are grouped by workplace, office, school, university location etc. to which the respondent was travelling.  Statistics New Zealand expects to release further categorisations of data in 2025, including these responses grouped by place of usual residence, that is the origin of the travel to work or education.  

# Analysis  

This analysis covers two data sets:  

  - "Main means of travel to education, by educational institution address" (TED), and
  - "Main means of travel to work, by workplace address" (TWO).  

## Comparing and contrasting the data

These data share commonly defined elements:  

  - Age:  the age group of respondents, this analysis includes five-year groupings (e.g. 0-4 years, 5-9 years etc.)
  - Gender:  the gender of the respondent, a new addition for the 2023 census
  - Main means of travel:  the main means of travel the respondent used to get to place of work or education
  - Location:  the location of the educational institution or place of work, this analysis includes groupings by Region (e.g. "Wellington Region", "Northland Region" etc.)
  - Year:  the census year in which the response was collected.

Although the TED and TWO data share characteristics and features, there are some fundamental differences that are discussed next.  

### Structure of the TED and TWO data  

For each dataset, one row comprises a unique record across all five category columns, so the total number of rows is a function of the number of unique levels in each category (see Table \@ref(tab:uniqueVals)) 

`r knitr::kables(list(kable(tee |> select(-Value) |> summarise_all(n_distinct), valign = "t"), kable(two |> select(-Value) |> summarise_all(n_distinct), valign = "t")), caption = "Unique levels in each category of TED (left) and TWO (right) data", label = "uniqueVals")`

Thus the total number of rows for the TED data set is the product of the counts of distinct values in each category: `r tee |> select(-Value) |>summarise_all(n_distinct) |> paste(collapse="x")` = `r nrow(tee)`.  Similarly the total number of rows for the TWO data, following the same procedure, is also the product of the counts of distinct values in each category: `r two |> select(-Value) |>summarise_all(n_distinct) |> paste(collapse="x")` = `r nrow(two)`.

Note that the TWO data has fewer distinct levels for Age and more distinct levels for Travel_mode.  The "Main means of travel to work" category is actually the "Main means of travel to work (15 years of age and over)" and as such, excludes the age categories "0-4 years", "5-9 years" and "10-14 years".  

`r knitr::kables(list(kable(tee |> select(Travel_mode) |> unique(), row.names = F, col.names = "Modes of travel to education", ,valign = "t"), kable(tee |> select(Value) |> summary(), ,valign = "t")), label = "teeModeVal", caption = "Unique modes of travel to education and summary of Value column")`

Both TED and TWO data include:  "Bicycle", "Ferry", "Other", "Public bus", "Train", and "Walk or jog".  The most obvious mode that is unique to the TED data is "School bus" .  The TED data also includes: "Drive a car, truck or van", "Passenger in a car, truck or van", and "Study at home".  The TWO data (Table \@ref(tab:twoModeVal) ) includes corresponding modes, modified for the context, splitting driving a vehicle into: "Drive a company car, truck or van" and "Drive a private car, truck or van"; and expanding the passenger category to: "Passenger in a car, truck, van or company bus".  The TWO data also distinguishes the non-travelling mode into: "Did not go to work today" and "Work at home".

`r knitr::kables(list(kable(two |> select(Travel_mode) |> unique(), row.names = F, col.names = "Modes of travel to work", ,valign = "t"), kable(two |> select(Value) |> summary(), ,valign = "t")), label = "twoModeVal", caption = "Unique modes of travel to work and summary of Value column")` 

## Basic statistics  

### Main means of travel to education  

The TED data has `r nrow(tee)` rows across `r ncol(tee)` columns, with the "Value" column representing the count of observations for a given row.  

Table \@ref(tab:teeModeVal) shows that most counts in the "Value" column are reasonably low with the minimum and first quantile at 0, the median at `r median(tee$Value,na.rm = T)`, the third quantile at `r stats::quantile(tee$Value, probs = 0.75, na.rm = T)` and the mean at `r round(mean(tee$Value,na.rm = T),1)`.  The TED data has a maximum value of `r format(max(tee$Value,na.rm = T), nsmall = 0)` and over 3,000 missing (NA) observations.  

If we plot the "Value" column as a histogram (see Figure \@ref(fig:histTee) ), we see that the vast majority of counts are on the low end and we have to zoom right in to the lowest frequencies to discern counts higher than 5,000, which are vary rare.

```{r histTee, include=TRUE, fig.cap="Histograms for 'Main means of travel to education counts'"}
par(fig = c(0, 1, 0, 1))

hist(tee$Value, main = "Histogram: TED including low-frequency, high-value counts", xlab = "Value", breaks = 30)
par(fig = c(0.3, 1, 0.3, 0.9), new = T)
hist(tee$Value, ylim = c(0, 20), main= "Zoomed-in to high counts", xlab = "", ylab = "", breaks = 30)
par(mfrow = c(1, 1))
```

On further examination, Figure \@ref(fig:teeDot) shows the highest values in the TED data (i.e. >10,000) are mostly in the Auckland Region, for the "Passenger in a car, truck or van" and "Walk or jog" modes of travel.  A handful of high values occur in Canterbury Region and Waikato Region, both for mode "Passenger in a car, truck or van"

```{r teeDot, include = TRUE, fig.cap="Travel to education: values by location" }
# create a scatter plot to show the distribution of highest values
ggplot(data = tee) +
  geom_point(position = position_jitterdodge(),
             aes(x = factor(Location), 
                 y = Value, 
                 colour = Travel_mode, 
                 text = Value))  +
  coord_flip()+
  labs(title = "Travel to education values by location",
       y = "Value", x = "Location") +
  theme(legend.position = c(0.7, 0.6))

```


### Main means of travel to work

The TWO data has `r nrow(two)` rows across `r ncol(two)` columns, with the "Value" column again representing the count of observations for a given row. 

As with the TED data, Table \@ref(tab:twoModeVal) shows that most counts in the "Value" column are quite low with the minimum and first quantile at 0, the median at `r median(two$Value,na.rm = T)`, the third quantile at `r stats::quantile(two$Value, probs = 0.75, na.rm = T)` and the mean at `r round(mean(two$Value,na.rm = T),1)`.  The TWO data has a maximum value of `r format(max(two$Value,na.rm = T), nsmall = 0)` and over 4,000 missing (NA) observations.  

If we plot the "Value" column as a histogram (see Figure \@ref(fig:histTwo) ), we see that the vast majority of counts are on the low end and again we have to zoom in to the lowest frequencies to discern higher counts.

```{r histTwo, include=TRUE, fig.cap="Histograms for 'Main means of travel to work counts'"}
par(fig = c(0, 1, 0, 1))
hist(two$Value, main = "Histogram: TWO including low-frequency, high-value counts", xlab = "Value", breaks = 30)
par(fig = c(0.3, 1, 0.3, 0.9), new = T)
hist(two$Value, ylim = c(0, 20), main= "Zoomed-in to high counts", xlab = "", ylab = "", breaks = 30)
par(mfrow = c(1, 1))
```

Figure \@ref(fig:twoDot) shows the highest values in the TWO data (i.e. >10,000) are again mostly in the Auckland Region, for the "Drive a private car, truck or van" and "Work at home" modes of travel.  A handful of high values occur in Canterbury Region for mode "Drive a private car, truck or van".

```{r twoDot, include = TRUE, fig.cap="Travel to work: values by location" }
# create a scatter plot to show the distribution of highest values
ggplot(data = two) +
  geom_point(position = position_jitterdodge() ,
             aes(x = factor(Location), 
                 y = Value, 
                 colour = Travel_mode, 
                 text = Value))  +
  coord_flip()+
  labs(title = "Travel to work values by location",
       y = "Value", x = "Location") +
  theme(legend.position = c(0.7, 0.6))

```

## Modes of travel with extremely high counts

Figures \@ref(fig:teeDot) and \@ref(fig:twoDot) both show extremely high counts in the Auckland Region for "Passenger in a car, truck or van" and "Walk or jog" for TED data and for "Drive a private car, truck or van" and "Work at home" for the TWO data.  The Auckland Region includes several urban areas that used to be recognised as cities in their own right, but are currently captured within Statistics New Zealand's Auckland Region geographic definition.  The Auckland Region includes a population of over 1.5 million people, which is more than the next three most populous regions combined (Canterbury, Waikato, Wellington).  As such, high counts can be expected, although they may skew the analysis (recall the high mean Value for both data sets).  There are two possible methods for treating these issues of scale:  

  - use proportions for analysing mode share usage within regions in order to make reasonable comparisons
  - disaggregate the Auckland Region into its component geographies by dividing into Auckland Local Board groupings.  

Using proportions allows comparison between regions by adjusting for population size and provides an insight into preferences that may differ by region.  While proportions analysis allows for comparison between regions, consideration must (eventually) be given to the underlying population size, lest strong preferences of a small population mask weaker preferences of a much larger portion of the population.

Disaggregation to Local Board level increases the number of geographic areas for consideration and therefore the complexity, but it also provides for more granular analysis and potentially balances population size against other regions.   

## Travel to education by Region  

We can view the proportions of responses by region using a visual plot that considers the total number of responses within a region as 100% and the sum of responses for a particular mode of travel divided by the total as the proportion.  Figure \@ref(fig:propTED) shows a preference across all regions for "Passenger in a car, truck or van", "Walk or jog", "Drive a car, truck or van", and then "School bus" and "Study at home".  This shows that regardless of region, "Passenger in a car, truck or van" is the preferred means of travel to education, followed by "Walk or jog".  

```{r propTED, include = T, fig.cap= "Travel to education:  proportional modes of travel, by Region"}
# proportion bar chart for travel to education by region
prop_bar(df = tee, 
         df_lab = "to education",
         x = Location, 
         x_lab = "Region",
         fill = Travel_mode, 
         fill_lab = "Mode of travel") |> 
  htmlify()
```

```{r teeRgnFct, include=T, fig.dim = c(8, 9), fig.cap="Travel to education across all regions"}
wrapped(tee, Location, F, T) |> 
  htmlify()
```

Figure \@ref(fig:teeRgnFct) shows a breakdown of modes of travel to education by region, highlighting the effect of differing population-size in each region.  The scale for all plots are weighted to the values in Auckland Region, so regions with lower populations and therefore lower values are impossible to interpret.  By grouping regions of similar population sizes together, preferences for modes of travel become perceivable.  

### Travel to education:  Canterbury, Waikato, and Wellington regions 

#### Combined totals for 2018 and 2023  

```{r teeCWW, include = T, fig.cap="Travel to education, modes for Canterbury, Waikato, Wellington regions"}
# Canterbury, Waikato, Wellington
rgn1 <- "anter|elling|aikat"
wrapped(tee|> filter(str_detect(Location, rgn1)), Location, F) |> 
  htmlify()
```

Figure \@ref(fig:teeCWW) reinforces the clear preference for "Passenger in a car, truck or van" for Canterbury, Waikato, and Wellington regions, with counts close to 110,000 in Canterbury, over 100,000 in Waikato, and counts of close to 90,000 in Wellington.  "Walk or jog" is the next most popular mode of travel to education in these regions, with nearly 60,000 in Canterbury and Wellington, and just over 30,000 in Waikato.  There are differences in the third most preferred mode of travel to education across these regions, with "Drive a car, truck or van" in Canterbury Region (around 40,000) and Waikato (just under 30,000), whereas Wellington Region has around 20,000 preferring this mode.  

"Bicycle" is the next most popular mode in Canterbury, at around 20,000, but this mode is less popular than buses and studying at home in Waikato and Wellington.  "School bus" is popular across all three regions, at close to 25,000 in Waikato, around 20,000 in Canterbury, and over 15,000 in Wellington.  "Public bus" is more popular in Wellington (over 20,000) than in the other two regions and is ahead of "School bus" and "Study at home".  Of these three regions, only Wellington has "Train" as a popular mode of transport (over 10,000).  "Study at home" is above 15,000 for all three regions.

#### Change between 2018 and 2023  

Figure \@ref(fig:teeCWWyr) breaks down the total counts for travel to education into individual years for Canterbury, Waikato and Wellington regions.  While this plot provides some visibility of change between the census years 2018 and 2023 for each mode, it is difficult to make comparisons due to the positioning of the plots.  

```{r teeCWWyr, include = T, fig.dim = c(8, 6), fig.cap="Travel to education, modes for Canterbury, Waikato, Wellington regions, by year"}
# Canterbury, Waikato, Wellington
wrapped(tee|> filter(str_detect(Location, rgn1)), Location, T) |> 
  htmlify()
```

Figure \@ref(fig:teeChangesAbs) provides a more focussed presentation of the absolute change in counts for each mode between 2018 and 2023.  Similarly, Figure \@ref(fig:teeChangesPct) presents the percentage change, that is the proportion of change based on the 2018 count for a given mode.

```{r teeChangesAbs, include=T, fig.dim=c(8,3), fig.cap= "Travel to education absolute changes 2018 to 2023"}
changes(tee|> filter(str_detect(Location, rgn1)), Location, F) |> 
  htmlify()
```

Figure \@ref(fig:teeChangesAbs) shows the greatest absolute change in travel modes was for "Passenger in a car, truck or van" in Waikato (increase over 5,000) and Canterbury (increase close to 5,000).  "Study at home" increased across all three regions by close to 5,000 in Canterbury, over 4,000 in Wellington, and over 3,000 in Waikato.  Only Canterbury saw an increase in "Bicycle" (increase over 1,500), and "Walk or jog" (increase of around 1,000).  Waikato and Wellington regions both saw a decline in "Walk or jog", decreasing by nearly 6,000 in Wellington, and over 3,000 in Waikato.  Waikato saw a decrease in the total number of "Drive a car, truck or van", reducing by 1,500, while both Canterbury and Wellington both saw very small increases.  While both Canterbury and Waikato saw a reduction in "Public bus" and "School bus", Wellington saw an increase in "Public bus" (increase around 1,500), with no discernable change for "School bus".

Figure \@ref(fig:teeChangesPct) shows percentage change between 2018 and 2023, highlighting an increase in "Study at home" of over 60% for each region.  Although all regions saw a drop in "Train", only Wellington had significant numbers of train users and even those numbers were fairly low at around 5,000 for each of the two census years.

```{r teeChangesPct, include=T, fig.dim=c(8,3), fig.cap= "Travel to education % changes 2018 to 2023"}
changes(tee|> filter(str_detect(Location, rgn1)), Location, T) |> 
  htmlify()
```

### Travel to eduction:  Bay of Plenty, Manawatū-Whanganui, Otago, Hawke's Bay, and Northland regions  

```{r teeBMOHN, include = T, fig.dim = c(8, 6), fig.cap="Travel to education, modes for Bay of Plenty, Manawatū-Whanganui, Otago, Hawke's Bay, and Northland regions"}
# Bay of Plenty, Manawatū-Whanganui, Otago, Hawke's Bay, and Northland regions
rgn2 <- "enty|anawa|tago|awke|orthl"
wrapped(tee|> filter(str_detect(Location, rgn2)), Location, F) |> 
  htmlify()
```

Figure \@ref(fig:teeBMOHN) shows "Passenger" as the most preferred means of travel for Bay of Plenty (around 60,000), Hawke's Bay (35,000), Manawatū- Whanganui (over 40,000), and Northland (just over 35,000), but slightly less preferred (at just under 40,000) to "Walk or jog" (just over 40,000) in Otago.  Preferences differ slightly across regions with "School bus" (just over 20,000), "Walk or jog (around 20,000), "Private vehicle" (around 15,000) and study "At home" (just over 10,000). "School bus is second-most preferred mode for Northland (nearly 20,000), and third for Manawatū-Whanganui around 14,000).  "Walk or jog is second most preferred mode for Hawke's Bay (just under 15,000) and Manawatū-Whanganui (just under 20,000).  

```{r teeBMOHNyr, include = T, fig.dim = c(8, 8), fig.cap="Travel to education, modes for Bay of Plenty, Manawatū-Whanganui, Otago, Hawke's Bay, and Northland regions, by year"}
# BMOHN
wrapped(tee|> filter(str_detect(Location, rgn2)), Location, T) |> 
  htmlify()
```

Figure \@ref(fig:teeBMOHNyr) shows reasonably consistent preferences between 2018 and 2023 for all regions, with a noticeable increase in study "At home" across all regions and a decrease in "Walk or jog" for all regions except Otago.  There is greater detail in Figure \@ref(fig:teeAbsBMOHN) showing absolute increases of over 1,000 for study "At home", including increase of 2,500 in Bay of Plenty, over 1,500 in Manawatū-Whanganui and Otago, just under 1,500 in Northland and around 1,500 in Hawke's Bay.  All regions show an increase in "Passenger" with greatest increases in Manawatū-Whanganui, Hawke's Bay (both just under 2,500), Northland (around 2,000), with increases of less than 500 in Bay of Plenty and Otago.  All regions had decreased counts for "Walk or jog" with decrease of more than 2,000 in Manawatū-Whanganui, around 1,500 in Bay of Plenty and Hawke's Bay, and a decrease of just under 1,000 in Northland.  Only Bay of Plenty saw an increase in use of "School bus" (up nearly 1,500) with all other regions decreasing by 1,000 or less.

```{r teeAbsBMOHN, include=T, fig.dim=c(8,3), fig.cap= "Travel to education absolute changes 2018 to 2023"}
changes(tee|> filter(str_detect(Location, rgn2)), Location, F) |> 
  htmlify()
```

Figure \@ref(fig:teePctBMOHN) shows several very high percentage changes for "Ferry", with ranging between a decrease of 50% to an increase of 200%, but considering the very low counts of in both census years, these high percentages are have very low impact.  All regions had increase of around 50% for study "At home".  "Public bus" usage increased by 75% in Northland and close to 50% in Otago.

```{r teePctBMOHN, include=T,fig.dim=c(8,3), fig.cap= "Travel to education percent changes 2018 to 2023"}
changes(tee|> filter(str_detect(Location, rgn2)), Location, T) |> 
  htmlify()
```

### Travel to education:  Gisborne, Marloborough, Nelson, Tasman, West Coast, Southland  

Gisborne, Marlborough, Nelson, Tasman, West Coast and Southland all had most preferred mode of travel to education as "Passenger", at nearly 20,000 in Southland, nearly 12,000 in Gisborne, just over 7,500 in each of Marlborough, Nelson, and Tasman, with an increase of just under 5,000 in West Coast.  Southland, Gisborne, and Tasman have the same profile for next most preferred modes of travel with "School bus" (just over 7,500, around 3,000, and around 4,000 respectively) and "Walk or jog" (around 6,000 in Southland, and around 3,000 for both Gisborne and Tasman) at second and third.

```{r teeGMNTWS, include = T, fig.dim = c(8, 6), fig.cap="Travel to education, modes for Gisborne, Marlborough, Nelson, Tasman, West Coast, and Southland regions"}
# Bay of Plenty, Manawatū-Whanganui, Otago, Hawke's Bay, and Northland regions
rgn3 <- "isb|arlb|els|asma|oast|outhl"
wrapped(tee|> filter(str_detect(Location, rgn3)), Location, F) |> 
  htmlify()
```

"Walk or jog" was second most preferred at Nelson (over 5,000), followed by "Private vehice" (around 3,000), and then "School bus" (around 2,000).  Marlborough has around 2,500 opting for "Walk or jog" with slightly less than 2,500 using "School bus".  West Coast has 
just under 2,500 "School bus" and just over 2,000 for "Walk or jog"

```{r teeGMNTWSyr, include = T, fig.dim = c(8, 8), fig.cap="Travel to education, modes for Gisborne, Marlborough, Nelson, Tasman, West Coast, and Southland regions, by year"}
# BMOHN
wrapped(tee|> filter(str_detect(Location, rgn3)), Location) |> 
  htmlify()
```

Figure \@ref(fig:teeGMNTWSyr) shows similar preferences between census years in each region, with only Gisborne Marlborough and Nelson showing a change in the order of preference for modes of travel.  Gisborne had "Walk or jog" going from second to third, exchanging place with "School bus", Marlborough had study "At home" shift from fifth to third, moving ahead of "School bus" and "Bicycle".  Nelson saw study "At home" go from sixth to fifth, ahead of "School bus".

```{r teeAbsGMNTWS, include=T, fig.dim=c(8,3), fig.cap= "Travel to education absolute changes 2018 to 2023"}
changes(tee|> filter(str_detect(Location, rgn3)), Location, F)  |> 
  htmlify()
```

Figure \@ref(fig:teeAbsGMNTWS) shows that the largest changes between 2018 and 2023 were increase in "Passenger", over 700 in Gisborne, and nearly 600 in Southland.  Southland and Gisborne also saw relatively large decrease in "Walk or jog", dropping by nearly 800 in Southland and nearly 600 in Gisborne.


```{r teePctGMNTWS, include=T, fig.dim=c(8,3), fig.cap= "Travel to education percent changes 2018 to 2023"}
changes(tee|> filter(str_detect(Location, rgn3)), Location, T)  |> 
  htmlify()
```

The highest percentage changes occur in Nelson, Tasman, with 100% decrease in "Ferry", along with a 50% increase in "Ferry" for Gisborne and Southland. All regions saw an increase of between 25-50% for study "At home".  Nelson and Tasman also saw increase in "Public bus" (over 25% in Nelson and nearly 50% in Tasman).  All other regions saw a decrease in "Public bus", dropping by more than 50% for West Coast, and around 25% in Gisborne and Marlborough.

### Preferred modes of travel to education by Region

Figure \@ref(fig:teePrefReg) summarises preferred modes of travel by region, ranking each travel mode by total count, with each mode linked by lines between different regions.  The most preferred mode across almost all regions is "Passenger", with the exception of Otago, where "Passenger" is ranked second.  For most regions, the second ranked mode of travel is "Walk or jog", with the exceptions of Otago, which ranked it first, and Bay of Plenty, Gisborne, Northland, Southland, Tasman, and West Coast where "Walk or jog" was ranked third.  All those regions (except Otago) ranked "School bus" second, Hawke's Bay, Marlborough, Taranaki ranked "School bus" third, Manawatū-Whanganui, Otago and Waikato ranked "School bus" fourth, and Auckland, Canterbury, Nelson and Wellington ranked "School bus" at fifth most preferred.

```{r teePrefReg, include=T, fig.cap = "Preferred modes of travel to education, by region"}
ranked_travel_modes(tee, Location, c("education", "region")) |> 
  htmlify()
```

"Public bus" was ranked third for Auckland and Wellington, ranked sixth in Manawatū-Whanganui, Northland, Otago, and Waikto, ranked seventh in Bay of Plenty, Canterbury, Hawke's Bay, Nelson, Southland, and Taranaki, and ranked eighth in Gisborne, Marlborough Tasman, and West Coast.  "Private vehicle" ranked third in Canterbury, Manawatū-Whanganui, Nelson, Otago, Waikato, ranked fourth in Auckland, Bay of Plenty, Gisborne, Hawke's Bay, Southland, and Wellington and was ranked fifth or sixth in the remaining regions.

Study "At home" ranks fourth, fifth, or sixth across all regions, with Marlborough, Northland, Taranaki, Tasman and West Coast ranking it fourth, Bay of Plenty, Gisborne, Hawke's Bay, Manawatū-Whanganui, Otago, Southland, and Waikto ranking it fifth, and Auckland, Canterbury, Nelson, and Wellington ranking it at sixth most preferred mode.  "Bicycle" is ranked between fourth and eighth across all regions, fourth in Canterbury and Nelson, fifth in Marlborough and Tasman, sixth in Bay of Plenty, Gisborne, Hawke's Bay, Southland, Taranaki and West Coast, seventh in Manawatū-Whanganui, Northland, Otago and Waikato, and ranked eighth in Auckland and Wellington.  

"Train" was ranked seventh in Auckland and Wellington, and ninth or tenth in all other regions.  "Other" was ranked seventh in Gisborne, Marlborough, Tasman and West Coast, ranked ninth in Auckland and Wellington, and ranked eighth in all other regions.  "Ferry" was ranked ninth or tenth in all regions, with Bay of Plenty, Canterbury, Gisborne, Marlborough, and Tasman ranking it ninth and the remainder ranking it at tenth.

### Summary of travel to education by region  

The preferred mode of travel to education across all regions and both census years is "Passenger", followed by "Walk or jog", "School bus", "Private vehicle", and study "At home".  All regions saw high increases for study "At home" (i.e. either first or second highest increase in preferred mode) and most regions saw increases for "Passenger".  Although some regions saw very high percentage changes, the majority were for modes of travel that had very low counts to begin with so have little influence on preferences within a region.  

## Travel to work by Region  

Figure \@ref(fig:propTWO) shows the proportion of different modes of travel to work, by region.  

```{r propTWO, include = T, fig.cap= "Travel to work:  proportional modes of travel, by Region"}
# proportion bar chart for travel to work by region
prop_bar(df = two, 
         df_lab = "to work",
         x = Location, 
         x_lab = "Region",
         fill = Travel_mode, 
         fill_lab = "Mode of travel") |> 
  htmlify()
```

Figure \@ref(fig:propTWO) shows proportions for modes of travel to work, with a clear preference for "Private vehicle", followed by work "At home" and then "Company vehicle".  These preferences are consistent across all regions.  "Public bus" have fourth highest proportions in Wellington, Auckland, Otago and Canterbury.  "Train" is fifth highest proportion for Wellington.  "Bicycle" is fourth highest proportion in Canterbury, fifth highest proportion in Nelson, Marlborough, and Tasman.

```{r twoRgnFct, include=T, fig.dim = c(8, 9),  fig.cap="Travel to work across all regions"}
wrapped(two, Location, F, T) |> 
  htmlify()
```

Regional totals are shown in Figure \@ref(fig:twoRgnFct).  Auckland has a much higher population than all other regions, so grouping into similar population-sized groups is still appropriate.  

### Travel to work:  Canterbury, Waikato, Wellington  

Figure \@ref(fig:twoCWW) shows "Private vehicle" is the most preferred with nearly 400,000 in Canterbury, nearly 275,000 in Waikato, and just under 250,00 in Wellington.  Work "At home" is the next most popular mode of travel to work, at nearly 100,000 in Canterbury, and around 80,000 in each of Waikato and Wellington.  "Company vehicle" is third most popular for Canterbury (around 80,000) and Waikato (just over 50,000), but is fifth most popular in Wellington (at just under 50,000), behind "Walk or jog" (just over 50,000) and "Public bus" (around 50,000).

```{r twoCWW, include = T, fig.cap="Travel to work, modes for Canterbury, Waikato, Wellington regions"}
wrapped(two|> filter(str_detect(Location, rgn1)), Location, F) |> 
  htmlify()
```

Figure \@ref(fig:twoCWWyr) shows that preferences in all three regions remain mostly consistent between 2018 and 2023, with only study "At home" changing in order of preference.  All three regions have an increase for work "At home", which also overtakes "Company vehicle" in Canterbury. 

```{r twoCWWyr, include = T, fig.cap="Travel to work, modes for Canterbury, Waikato, Wellington regions, by year"}
wrapped(two|> filter(str_detect(Location, rgn1)), Location) |> 
  htmlify()
```

For all regions, work "At home" increased the most between 2018 and 2023, by over 30,000 in Wellington, 15,000 in Canterbury and around 12,000 in Waikato.  Figure \@ref(fig:twoAbsCWW) "Private vehicle" increased by around 8,000 in Canterbury and just under 5,000 in Waikato, but decreased by nearly 4,000 in Wellington, which also saw a reduction in "Walk or jog" (around 4,000) and "Train" (around 3,000).

```{r twoAbsCWW, include=T, fig.dim = c(8,3), fig.cap= "Travel to work absolute changes 2018 to 2023"}
changes(two|> filter(str_detect(Location, rgn1)), Location, F)  |> 
  htmlify()
```

Percentage change in Figure \@ref(fig:twoPctCWW) are dominated by an increase of 125% for work "At home" in Wellington.  Both Canterbury and Waikato see an increase of around 40% in work "At home".  "Train" and "Walk jog" reduce by around 10% in Wellington.  Although there are reasonably high percentage changes for other modes of travel in Canterbury and Waikato, those modes have very low total counts (e.g. "Other" and "Train").  

```{r twoPctCWW, include=T, fig.dim = c(8,3), fig.cap= "Travel to work percent changes 2018 to 2023"}
changes(two|> filter(str_detect(Location, rgn1)), Location, T) |> 
  htmlify()
```

### Travel to work:  Bay of Plenty, Manawatū-Whanganui, Otago, Hawke's Bay, and Northland  

Combined totals across 2018 and 2023 for travel to work in Bay of Plenty, Hawke's Bay, Manawatū-Whanganui, Northland and Otago are shown in Figure \@ref(fig:twoBMOHN).  "Private vehicle" is the most preferred mode of travel across all five regions, with around 180,000 in Bay of Plenty, 140,000 in Manawatū-Whanganui, 130,000 in Otago, just over 100,000 in Hawke's Bay and just under 100,000 in Northland.  Preferences are consistent across all regions with work "At home" second, "Company vehicle" third and either "Walk or jog" or "Passenger" coming in at fourth.  Total counts for work "At home" are around 50,000 in Bay of Plenty, around 40,000 in Otago and Manawatū-Whanganui, around 30,000 in Northland and around 25,000 in Hawke's Bay.  "Company vehicle" has around 40,000 in Bay of Plenty, 30,000 in Otago, just over 25,000 in Manawatū-Whanganui and just under 25,000 in Hawke's Bay and Northland.

```{r twoBMOHN, include = T, fig.dim = c(8, 6), fig.cap="Travel to work, modes for Bay of Plenty, Manawatū-Whanganui, Otago, Hawke's Bay, and Northland regions"}
wrapped(two|> filter(str_detect(Location, rgn2)), Location, F) |> 
  htmlify()
```

Counts for census years 2018 and 2023 (Figure \@ref(fig:twoBMOHNyr)) shows that preferences remain generally consistent within each region across both years, with preferred modes being "Private vehicle", work "At home", "Company vehicle", and "Walk or jog".  Of these first four preferred modes, only "Walk or jog" saw a decrease between 2018 and 2023.  

```{r twoBMOHNyr, include = T, fig.dim = c(8, 8), fig.cap="Travel to work, modes for Bay of Plenty, Manawatū-Whanganui, Otago, Hawke's Bay, and Northland regions, by year"}
wrapped(two|> filter(str_detect(Location, rgn2)), Location) |> 
  htmlify()
```

Figure \@ref(fig:twoAbsBMOHN) quantifies the change between 2018 and 2023 showing the biggest absolute increase was for work "At home", increasing by more than 7,000 in Bay of Plenty, by over 4,000 in Otago, Northland and Manawatū-Whanganui, and by more than 2,500 in Hawke's Bay.  "Private vehicle" increased by over 4,000 in Bay of Plenty, by more than 3,000 in Manawatū-Whanganui, by just under 3,000 in Otago and by around 2,000 in Northland and Hawke's Bay.  "Company vehicle" saw smaller increases (between 1,000 and 2,000) for all five regions.  Counts of "Walk or jog" decreased in all regions, by around 1,000 in Otago and Manawatū-Whanganui and Bay of Plenty, and by less than 500 in Northland and Hawke's Bay.

```{r twoAbsBMOHN, include=T, fig.dim = c(8,3), fig.cap= "Travel to work absolute changes 2018 to 2023"}
changes(two|> filter(str_detect(Location, rgn2)), Location, F)  |> 
  htmlify()
```

Percentage changes in Figure \@ref(fig:twoPctBMOHN) are dominated by high percentages for low volume changes, such as more than doubling for "Ferry" in Manawatū-Whanganui, and decreasex of 50% for "Ferry" in Otago, more than 50% for "Train" in Bay of Plenty.  Work "At home" increased by over 25% in Bay of Plenty, Northland, Manawatū-Whanganui, and Otago, and by just under 25% in Hawke's Bay. 

```{r twoPctBMOHN, include=T, fig.dim = c(8,3), fig.cap= "Travel to work percent changes 2018 to 2023"}
changes(two|> filter(str_detect(Location, rgn2)), Location, T)  |> 
  htmlify()
```

### Travel to work:  Gisborne, Marloborough, Nelson, Tasman, West Coast, Southland  

Figure \@ref(fig:twoGMNTWS) shows the total counts for Travel to work in Gisborne, Marlborough, Nelson, Tasman, West Coast, and Southland.  Combined preferences for 2018 and 2023 census years show that "Private vehicle" is most preferred for all six regions, with 60,000 in Southland, over 30,000 in Nelson and just under 30,000 in Marlborough and Tasman.  West Coast has around 19,000 for "Private vehicle".  Across all six regions, work "At home" is second" and "Company vehicle" is third and "Walk or jog" is fourth most preferred mode of travel.

```{r twoGMNTWS, include = T, fig.dim = c(8,6), fig.cap="Travel to work, modes for Gisborne, Marloborough, Nelson, Tasman, West Coast, Southland regions"}
wrapped(two|> filter(str_detect(Location, rgn3)), Location, F) |> 
  htmlify()
```

Counts for 2018 and 2023 are shown in Figure \@ref(fig:twoGMNTWSyr) and preferences are consistent between the two census years for most regions.  

```{r twoGMNTWSyr, include = T, fig.dim=c(8, 8), fig.cap="Travel to work, modes for Gisborne, Marloborough, Nelson, Tasman, West Coast, Southland regions, by year"}
wrapped(two|> filter(str_detect(Location, rgn3)), Location) |> 
  htmlify()
```

Absolute changes for these six regions are shown in Figure \@ref(fig:twoAbsGMNTWS).  The highest change was in Tasman with an increase of over 1,500 for work "At home", followed by increases of around 1,500 for "Private vehicle" in each of Southland and Gisborne.  Work "At home" increased by around 900 in Nelson, which was the largest mode change for the region, and just over 500 in Gisborne.  "Private vehicle" increased by just over 500 in Marlborough, and around 400 in Tasman and West Coast.  All six regions saw a decrease in "Walk or jog".  Nelson saw an increase of over 500 for "Bicycle" between years 2018 and 2023.

```{r twoAbsGMNTWS, include=T, fig.dim = c(8,3), fig.cap= "Travel to work absolute changes 2018 to 2023"}
changes(two|> filter(str_detect(Location, rgn3)), Location, F)  |> 
  htmlify()
```

Percentage changes between 2018 and 2023 are dominated by high percentage changes in rarely used modes, such "Ferry" (200% increase in Nelson, 100% decreases in Gisborne and West Coast etc.) and "Train" (200% increase in Marlborough, 100% decrease in West Coast, and over 50% decreases in Nelson and Tasman).

```{r twoPctGMNTWS, include=T, fig.dim = c(8,3), fig.cap= "Travel to work percent changes 2018 to 2023"}
changes(two|> filter(str_detect(Location, rgn3)), Location, T)  |> 
  htmlify()
```


### Preferred modes of travel to work by region

Highest ranked modes of travel to work are consistent across all regions with "Private vehicle" ranked first, and work "At home" ranked second.  For most regions, "Company vehicle" is ranked third, with the exception of Wellington where "Walk or jog" is ranked third, and "Company vehicle" is ranked fifth.  "Public bus" is ranked fourth in Auckland and Wellington, sixth in Otago, seventh in Canterbury and ranked eighth in all other regions.

```{r twoPrefAge, include=T, fig.cap = "Preferred modes of travel to work, by region"}
ranked_travel_modes(two, Location, c("work", "region")) |> 
  htmlify()
```

"Passenger" is ranked fourth in Bay of Plenty, Gisborne, Hawke's Bay, Northland, and Southland, ranked fifth in Auckland, Manawatū-Whanganui, Marlborough, Otago, Taranaki, and Waikato, ranked sixth in Canterbury, Nelson and Tasman, and ranked seventh in Wellington.  "Walk or jog" is ranked fourth in Manawatū-Whanganui, Marlborough, Otago, Taranaki, Tasman, Waikato, and West Coast, ranked fifth in Bay of Plenty, Canterbury, Gisborne, Hawke's Bay, Nelson, Northland, and Southland, and ranked sixth in Auckland. "Bicycle" is ranked fourth in Canterbury and Nelson, ranked fifth in Tasman, sixth in Gisborne, Hawke's Bay, Manawatū-Whanganui, Marlborough, and West Coast, ranked seventh in Northalnd, Otago, Southland, Taranaki, and Waikato, ranked eighth in Wellington and ninth in Auckland.  

The "Other" mode is ranked sixth in Northland, Southland, Taranaki, and Waikato, seventh in Bay of Plenty, Gisborne, Hawke's Bay, Manawatū-Whanganui, Marlborough, Nelson, and Tasman, ranked eighth in Auckland, Canterbury and Otago, and ranked ningth in Wellington.  "Train" is ranked sixth in Wellington, seventh in Auckland, ninth in Gisborne, Hawke's Bay, Manawatū-Whanganui, Nelson and Waikato, and ranked tenth in all other regions. "Ferry" is ranked ninth most preferred mode of travel to work in Bay of Plenty, Canterbury, Marlborough, Northland, Otago, Southland, Taranaki, Tasman and West Coast, and ranked tenth in all other regions.  "No work" was ranked eleventh in all regions 


### Summary of travel to work by region  

The most preferred means of travel to work across all regions was "Private vehicle", work "At home", and then "Company vehicle".  Regional results are dominated by the large population in the Auckland region, but analysis conducted across groups of similar population-sized regions generally reinforced the preferred modes, albeit at lower volumes.  Work "At home" increased between 2018 and 2023 for almost all regions (with the exception of West Coast), and along with "Private vehicle", was in the top two highest increasing modes in almost all regions, where only Wellington saw a decrease in the use of "Private vehicle". All regions saw a decrease in "Walk or jog"


## Preferred modes of travel by Age  

The Travel to education data includes aggregation by age into five-year groupings, 0-4 years, 5-9 years, ... all the way to 90+ years.  Data in this section is presented using a dot-plot that indicates the value (at each intersection), combined with a bump plot that connects each mode of travel across the different age groups.  These plots can be used to explain differences in preferred mode of travel across age groups.

## Travel to education by Age  

Figure \@ref(fig:teeAgeRank) shows several changes in preference between ages 10 to 15, ages 15 to 20

```{r teeAgeRank, include = T, fig.cap = "Preferred modes of travel to education, by age"}
ranked_travel_modes(tee, Age, c("education", "age")) |> 
  htmlify()
```


## Travel to work by Age  

Since the Travel to work category is restricted by age (i.e. 15 years and over) there is no data for age groups 0-4 years, 5-19 years, and 10-14 years.

```{r twoAgeRank, include = T, fig.cap = "Preferred modes of travel to work, by age"}
ranked_travel_modes(two, Age, c("work", "age")) |> 
  htmlify()
```





