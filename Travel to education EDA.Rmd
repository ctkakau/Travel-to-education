---
title: "DATA581:  Waka Kotahi - Travel to education"
author: 'Chad Kakau: 300212228'
date: "2024-11-29"
output: html_document

---

```{r setup, include=FALSE, warnings = FALSE}
# set default options for knitting the document
knitr::opts_chunk$set(
  include = FALSE, 
  echo = FALSE, 
  warnings = FALSE, 
  message = FALSE)

# set java memory to 4GB, turn off scientific notation
options(java.parameters = "-Xmx4G",
        scipen = 0
        )

# bring in the libraries
library(data.table)
library(dplyr)
library(ggplot2)
library(httr)
library(jsonlite)
library(leaflet)
library(leaflet.providers)
library(osmdata)
library(plotly)
library(rJava)
#library(r5r)
library(sf)
library(stars)
library(sys)
library(tidyverse)
library(tidyr)
library(viridisLite)

# set theme for ggplot2
ggplot2::theme_set(theme_classic())


```

# Travel to education project

This project reviews the importance of 'travel to education' on New Zealand's land transport system.  

Essentially an exploratory analysis, the project will draw on officially available information to identify any insights that may become apparent.  Data is drawn from a range of sources including:

  - Statistics New Zealand Census data (from 2013, 2018, 2023)
  - Reporting prepared for Waka Kotahi that models expected travel times








# Introduction
SOMETHING ABOUT 
  
  
  

```{r readInDimTablesLong, include = FALSE, echo = FALSE} 
# # read in dimension tables that link SA1 to SA2, SA3, Territorial and regional authorities
# there are more elegant ways to get these in but, this is for transparency

if(!file.exists('statistical_areas.csv')){
  if (!exists('statistical_areas')){
    
    ### ensure all csv files are in the same folder and then update folder path here: ###
    sa_folder<- c("C:/Users/chad/Downloads/")
    
    
    # read in each csv file
    sa1_to_sa2 <- read.csv(
      paste(sa_folder, "SA1 to SA2 2023.csv", sep = ""),
        skip = 7, header = F)
    sa1_to_sa2 <- sa1_to_sa2[, c(1,4, 5)]
    colnames(sa1_to_sa2) <- c("SA1", "SA2", "SA2_chx")
    
    sa1_to_sa3 <- read.csv(
      paste(sa_folder, "SA1 to SA3 2023.csv", sep = ""),
        skip = 7, header = F)
    sa1_to_sa3 <- sa1_to_sa3[, c(1,4, 5)]
    colnames(sa1_to_sa3) <- c("SA1", "SA3", "SA3_chx")
    
    sa1_to_rc <- read.csv(
      paste(sa_folder, "SA1 to RC.csv", sep = ""),
        skip = 7, header = F)
    sa1_to_rc <- sa1_to_rc[, c(1, 5)]
    colnames(sa1_to_rc) <- c("SA1", "Regional Council")
    
    sa2_to_ta <- read.csv(
      paste(sa_folder, "SA2 to TA 2023.csv", sep = ""),
        skip = 7, header = F)
    sa2_to_ta <- sa2_to_ta[, c(1, 5)]
    colnames(sa2_to_ta) <- c("SA2", "Territorial Authority")
    
    
    # consolidate into a single object
    statistical_areas <- sa1_to_sa2 %>%
      left_join(sa1_to_sa3, by = "SA1") %>%
      left_join(sa1_to_rc, by = "SA1") %>%
      left_join(sa2_to_ta, by = "SA2")
    
    # tidy up workspace
    rm(list = c('sa1_to_sa2', 'sa1_to_sa3', 'sa1_to_rc', 'sa2_to_ta'))
  }
  write.csv(statistical_areas, 'statistical_areas.csv')
  rm(sa_folder)
} else {
  # read in from the csv file generated in long version
  stat_areas <- read.csv('statistical_areas.csv', row.names = 'X')
}

```


```{r readInCensusData, include = FALSE, echo=FALSE}
# read in census data from local file
path <- c("C:/Users/chad/Downloads/STATSNZ,CEN23_TBT_012,1.0+all.csv")
prev_written <- 'census_2018_2023.csv'

# check for the created census_2018_2023.csv file and if not exists, extract 
# data and create it
if (!file.exists(prev_written)) {
  begin <- Sys.time()
  census <- read.csv(path)
  
  # remove unused columns: DATAFLOW, OBS_STATUS
  census$DATAFLOW <- NULL
  census$OBS_STATUS..Observation.Status <- NULL
  
  # retain just the used variables:  travel to education by educational institution address (tee)
  # travel to education by usual residence (teu); income bracket (ib); highest qualification (hq)
  # residence 1 year ago (1y) and resident 5 years ago (5y)
  census <- census %>%
    # dplyr::filter(stringr::str_starts(CEN23_TBT_IND_003..Variable.codes ,
    #                                   "(?i)1y|5y|tee|teu|ib|hq")) %>%
  
    # remove empty values (censored data)
    dplyr::filter(!is.na(OBS_VALUE))%>%
  
    # remove rows with variable totals
    dplyr::filter(!stringr::str_detect(CEN23_TBT_GEO_002..Area,
                                        "(?i)Total")) %>%
  
    # split Variable.Codes column into code and variable text
    tidyr::separate_wider_delim(
      CEN23_TBT_IND_003..Variable.codes,
      delim = ': ',
      names = c('Var_Code', 'Variable')) %>%
  
    # split Statistical areas column into code and variable text
    tidyr::separate_wider_delim(
      CEN23_TBT_GEO_002..Area,
      delim = ': ',
      names = c('SA1', NA)) %>%
  
    # convert type SA1 to integer
    mutate(SA1 = as.integer(SA1)) %>%
    # add geographic areas to main dataset
      left_join(y = stat_areas,
                by = join_by(SA1),
                unmatched = 'error',
                relationship = 'many-to-one') %>%
  
    # create shortCode column for summary totals
    mutate(shortCode = ifelse(substr(Var_Code, 1, 2) == "1y","1y",
      ifelse(substr(Var_Code, 1, 2) == "5y", "5y",
      sub("^(\\D+).*", "\\1", Var_Code)))
      
      # # no longer required
      # substr(Var_Code, 1, 3) == "tee" ~ "tee",
      # substr(Var_Code, 1, 3) == "teu" ~ "teu",
      # substr(Var_Code, 1, 2) == "ib" ~ "ib",
      # substr(Var_Code, 1, 2) == "hq" ~ "hq")
      )
  
  # regex substring
  # unique(sub("^(\\D+).*", "\\1", unique(census$Var_Code)))
  
  
  
  
  # rename columns
  names(census)[4:5] <- c("Year", "Value")
  
  # # performance
  end <- Sys.time()
  loadingTime <- end - begin
  loadingTime
  # around 1.5 min to load and filter to desired set
  
  # write to file and reload from file
  write.csv(census, prev_written)

} else {
  
  begin <- Sys.time()
  # from here once the csv file has been created
  census <- read.csv('census_2018_2023.csv', row.names = 'X')
  end <- Sys.time()
  loadingTime <- end - begin
  loadingTime
}
  



# #  create object to hold the TS (total stated) values
# totals <- census %>% 
#   # filter in  the TS (Total Stated) rows
#   dplyr::filter(stringr::str_ends(Var_Code,"(?i)TS")) 
# 
# 
# # create a TS (total stated) column to hold the TS for each SA1, year, and topic
# census <- census %>% 
#   # filter in  the Total and Total Stated rows
#   dplyr::filter(!stringr::str_detect(Var_Code,"(?i)TS|Total|Med")) %>%
#   
#   # join census and totals table 
#   left_join(y = totals[,c("SA1", "shortCode", "Year", "Value")],
#             by = c("SA1", "Year", "shortCode"),
#             relationship = 'many-to-one'
#             ) %>%
#   
#   # rename to useful column names
#   rename(c(Value = "Value.x", TS = "Value.y"))
```



```{r possibleDatasets}
# # pivot the census data by shortCode, key= SA1
# census_wide <- census %>%
#   pivot_wider(id_cols =  c(Regional.Council, Variable),
#               names_from = shortCode,
#               values_from = Value,
#               values_fn = sum)
# 
# # summarise data to a smaller set
# r_census <- census %>%
#   group_by(Year, shortCode, Regional.Council, Territorial.Authority, SA2_chx, Variable) %>%
#   summarise(count = sum(Value))
# 
# 
# # filter a dataset to focus on Auckland
# akl_census <- census %>%
#   filter(Regional.Council == "Auckland Region") %>%
#   group_by(Year, shortCode, SA3_chx, SA2_chx, Variable) %>%
#   summarise(count = sum(Value)) 
```

```{r readInShapeFilePaths}
if (!exists('shp_sa1')){
  # shapefiles are available from StatsNZ Geographic Data Service at: 
  # https://datafinder.stats.govt.nz/ 
  shp_folder <-  c("C:/Users/chad/OneDrive - Victoria University of Wellington - STUDENT/DATA581 - waka kotahi/StatsNZShapeFiles/")
  shp_sa1 <- paste0(shp_folder, "statistical-area-1-2023-generalised.shp", sep = "")
  shp_sa2 <- paste0(shp_folder, "statistical-area-2-2023-generalised.shp", sep = "")
  shp_sa3 <- paste0(shp_folder, "statistical-area-3-2023-clipped-generalised.shp", sep = "")
  shp_ta <- paste0(shp_folder, "territorial-authority-2023-clipped-generalised.shp", sep = "")
  shp_rc <- paste0(shp_folder, "regional-council-2023-clipped-generalised.shp", sep = "")
  shp_ur <- paste0(shp_folder, "urban-rural-2023-generalised.shp", sep = "")
}
```

```{r travelToEducationByUsuallyResident}
# object to hold the travel to education data without totals
teu <- census %>% 
  # filter out the Total and Total Stated rows
  dplyr::filter(!stringr::str_detect(Var_Code,"(?i)TS|Total|Med"))%>%
  dplyr::filter(stringr::str_starts(Var_Code , 
                                    "(?i)teu")) 

# object to report the main means of travel and create short names
teuMode <- unique(teu$Variable)
mode_labeller <- data.frame(Variable = teuMode, TravelMode = c("Home", "Drive", "Passenger", "Bicycle", "Walk", 
                                  "School bus", "Public bus", "Train",
                                  "Ferry", "Other", "Not elsewhere"))

# object to report the main regions and create short names
teuRegion <- unique(teu$Regional.Council)
Region <- unlist(strsplit(teuRegion, " Region"))
region_labeller <- data.frame(Regional.Council = teuRegion, Region = Region )

teu <- teu %>%
  left_join(y = mode_labeller,
            by = c("Variable"), 
            relationship = 'many-to-one') %>%
  left_join(y = region_labeller,
            by = c("Regional.Council"),
            relationship = 'many-to-one')

rm(list = c("teuMode", "mode_labeller", "teuRegion", "region_labeller", "Region"))

```





```{r summarisedDatasets}
#### just do this as you need the dataset, then remove after it's been used
# # summarise data at Territorial level
# census_ta <- census %>%
#   group_by(Year, Regional.Council, Territorial.Authority, shortCode, Variable)%>%
#   summarise(total = sum(Value))
# #census_ta[15000:15005,]
# 
# # summarise data at Regional level
# census_rc <- census %>%
#   group_by(Year, Regional.Council, shortCode, Variable)%>%
#   summarise(total = sum(Value))
# #census_rc[3000:3005, ]
# 
# summary(glm(total~factor(Year)+Variable,
#     data = census_rc[census_rc$shortCode=="pq",],
#     family = 'poisson'))
# 
# # summarise data at SA3
# census_sa3 <- census %>%
#   group_by(Regional.Council, Territorial.Authority, SA3_chx, shortCode, Variable)%>%
#   summarise(total = sum(Value))
# 
# # summarise data at SA2
# census_sa2 <- census %>%
#   group_by(Regional.Council, Territorial.Authority, SA2_chx,  shortCode, Variable)%>%
#   summarise(total = sum(Value))  
```


```{r widenedDatasets}
### just do this as required and then remove after used.

# # try making a wide table
# census_wide <- census %>%
#   pivot_wider(id_cols = c(SA1, SA2, SA2_chx, SA3, SA3_chx, Regional.Council,
#                           Territorial.Authority, shortCode),
#               names_from = Variable,
#               values_from = Value
#               )
# 
# names(census_wide)
# # census_wide[3,]
# 
# # produces a table that has a column for each possible variable (e.g. 'travel by bicycle', '$10,000-21,000' etc.)

```

# Methodology  

Overall process (and then add some more detail for each bullet point):  

  1. Describe data (summarise data based on Stats NZ and objectives of report)
  1. extract, clean, load data (define sources, transformations)
  1. Fit statistical models (mutually independent ((YM), (YR), (YM,YR)))
  1. Describe regional proportions (attributable to travel to education)
  1. Describe key modes by year (based on YM)
  1. Describe key regions by year (based on YR)
  1. Describe regional differences? 
  1. visualise regions with biggest changes (total and by mode) !these are the ones that have changed the most (future_indicators?)
  1. visualise regions with biggest proportions (by mode and changes) !these are the ones that have most people
  1. Report results
  1. Discuss results (are there any hypotheses?  they should be in introduction - possibly working from home, possibly shift to remote access work and study, possibly reduced international student numbers, possibly change in proportions of work vs study, possibly shift from urban to rural)
  1. Conclusion (is there reasonable evidence to support any of the hypotheses? where to look for more evidence and what to expect or investigate)

## Describe the data, where it comes from, what it describes

The majority of data used in this analysis comes from data collected and presented by Statistics New Zealand as summarised totals from Census 2018 and Census 2023.  The primary census questions of interest relate to how people travel to their place of education. 'Travel to education' provides respondents with several options for describing the method they used to travel to education on the day of the census.  The question was introduced as a persistent question in 2018 and was asked then and in 2023.  _The majority of this analysis considers only the positive responses to this question (i.e. people who were currently studying at the time of the census). [IT MAY BE MORE APPROPRIATE TO TAKE AS RATES RATHER THAN FREQUENCIES]_  

The census asks many questions about life in New Zealand so in addition to the primary topic of interest for this analysis there are other additional questions that may give useful context or insights, so additional responses are available:

Data for this project has come from several sources including:  

  - Statistics New Zealand:  
    - Census data retrieved from [Aotearoa Data Explorer](https://explore.data.stats.govt.nz/)  
      - [Totals by topic for individuals, (SA1), 2013, 2018, and 2023 Censuses](https://explore.data.stats.govt.nz/vis?fs%5B0%5D=2023+Census%2C0%7CTransport%23CAT_TRANSPORT%23&pg=0&fc=2023+Census&bp=true&snb=6&df%5Bds%5D=ds-nsiws-disseminate&df%5Bid%5D=CEN23_TBT_012&df%5Bag%5D=STATSNZ&df%5Bvs%5D=1.0&dq=.SA1Total.2013%2B2018%2B2023&ly%5Brw%5D=CEN23_TBT_IND_003&ly%5Bcl%5D=CEN23_YEAR_001&to%5BTIME%5D=false)
    - Geographic information retrieved from [Stats NZ Geographic Data Service](https://datafinder.stats.govt.nz/)  
      - [Statistical Area 1 2023 (generalised) shapefiles](https://datafinder.stats.govt.nz/layer/111208-statistical-area-1-2023-generalised/)
      - [Statistical Area 2 2023 (generalised) shapefiles](https://datafinder.stats.govt.nz/layer/111227-statistical-area-2-2023-generalised/)
      - [Statistical Area 3 2023 (generalised) shapefiles](https://datafinder.stats.govt.nz/layer/111202-statistical-area-3-2023-generalised/)
      - [Territorial Authority 2023 (generalised) shapefiles](https://datafinder.stats.govt.nz/layer/111194-territorial-authority-2023-generalised/)
      - [Regional Council 2023 (generalised) shapefiles](https://datafinder.stats.govt.nz/layer/111182-regional-council-2023-generalised/)
    - Classification tables for Statistical Areas 1, 2, 3, Territorial Authorities and Regional Authorities retrieved from [Stats NZ Aria, concept and classification management system](https://aria.stats.govt.nz/aria/)  
      - [Statistical Area 1 2023 V1.0.0](https://aria.stats.govt.nz/aria/#ClassificationView:uri=http://stats.govt.nz/cms/ClassificationVersion/sEMu6YTFdWqenzhR)
      - [Statistical Area 1 to Statistical Area 2 2023](https://aria.stats.govt.nz/aria/#ConcordanceView:uri=http://stats.govt.nz/cms/ConcordanceVersion/JxtI2hDKkMODwN1U)
      - [Statistical Area 1 to Statistical Area 3 2023](https://aria.stats.govt.nz/aria/#ConcordanceView:uri=http://stats.govt.nz/cms/ConcordanceVersion/nC0BBUXrbjn6exsh)
      - [Statistical Area 1 to Territorial Authority 2023](https://aria.stats.govt.nz/aria/#ConcordanceView:uri=http://stats.govt.nz/cms/ConcordanceVersion/rosoyMbii211crP0)
      - [Statistical Area 1 to Regional Council 2023](https://aria.stats.govt.nz/aria/#ConcordanceView:uri=http://stats.govt.nz/cms/ConcordanceVersion/oui0H1okeUvIdg9P)
      
      
_MAKE A COMMENT ON QUALITY (very high) OR NATURE (periodic, snapshot on census day, but is a survey of the population) OF CENSUS DATA AND GENERAL ASSUMPTIONS_

More detailed information about how to use 2023 Census data is available in the StatsNZ [2023 Census data user guide](https://www.stats.govt.nz/assets/Methods/2023-Census-data-user-guide/2023-census-data-user-guide.pdf).



## Describe the sources and transformation methods, include excel and R methods

This analysis was emulated across two different software platforms:  Microsoft Excel and RStudio.  Microsoft Excel is readily available within most government organisations in New Zealand and was used to ensure replicability and reproducibility for future census result sets.  RStudio offers a greater array of options for analysing, modelling, visualising, and reporting both methods and findings, but may not be available for government or organisational groups.  A github repository for developing and maintaining R scripts is also produced.  This section describes the sources and transformation methods used for preparing raw data for analysis: Raw census data; Processed census data; geographic hierarchies; and geographic information.

### Raw census data  

Raw census data was accessed by searching for the term "Main means of travel" in the [Aotearoa Data Explorer search engine](https://explore.data.stats.govt.nz/).  Data for all census variables is available at the result ["Totals by topic for individuals, (SA1), 2013, 2018, and 2023 Censuses (Download recommended - see overview for more information)"](https://explore.data.stats.govt.nz/vis?tm=Main+means+of+travel&pg=0&snb=16&df%5Bds%5D=ds-nsiws-disseminate&df%5Bid%5D=CEN23_TBT_012&df%5Bag%5D=STATSNZ&df%5Bvs%5D=1.0&dq=.SA1Total.2013%2B2018%2B2023&to%5BTIME%5D=false) is selected.  This full dataset is downloaded using the "Unfiltered data in tabular text (CSV)" option.  This downloads responses for all variables in the census and can be filtered once ingested.  Alternatively, smaller datasets that focus only on variables of interest (for instance those relating to travel to education by usual residence address (variable code beginning with "teu") and those relating to travel to education by address of educational institution (variable code beginning with "tee")).  The full dataset is around 4.5GB so can take a few minutes to download.

Transforming the raw census data involves stripping unused columns, filtering unused rows (i.e. variables), splitting the variables into short codes and full text columns, removing unnecessary text from the statistical area columns and then renaming columns with more user friendly labels.  The raw data csv file has six columns:  

  - __DATAFLOW__: contains the identifier for the Stats NZ dataflow, equivalent to search name - not used
  - __CEN23_TBT_IND_003: Variable codes__: contains the variable codes, with format "[Shortcode]: [FullText]" - retained and split into "Var_Code" and "Variable" columns
  - __CEN_TBT_GEO_002: Area__: contains the statistical area identifiers, with format "[SA1]: [SA1]" - retained all data before delimiter ": " and column renamed to "SA1"
  - __CEN23_YEAR_001: Census year__: contains the census year - retained, column renamed to "Year"
  - __OBS_VALUE__: contains the aggregated response count for the statistical area - retained and column renamed to "Value"
  - __OBS_STATUS: Observation status__: contains additional information when no value is given (e.g. "confidential" etc.) - not used
  
After processing the raw census data the resulting data frame has five columns with the number of rows determined by which variables are filtered in:  

  - __Var_Code__: character, short code for identifying (and filtering) variables
  - __Variable__: character, full text for variable/response
  - __SA1__: character, identifier for statistical area 1
  - __Year__: integer, identifier for census year
  - __Value__: integer, total count for individual responses within the statistical area 1
  
### Processed census data

Processed census data was compiled by a third party on behalf of Waka Kotahi and estimates the accessibility of education by considering the proximity of education institutions to the population within a statistical area 1 partition.  Using the open map system to determine walking paths, cycling routes, and vehicle paths, combined with travel time data based on GPS travel data, the processed census data estimates accessibility to education as number of people that could reach an educational institution within 15 minute blocks (e.g. within 15 minutes, within 30 minutes, within 45 minutes etc.).  This data is received as individual tables relating to geographic groupings (e.g. city, region, district etc.) and is processed to remove summarised data and convert to long table form.

__DESCRIBE THE DATA TABLE PRODUCED BY THIS PROCESS__


### Geographic hierarchies

Geographic hierarchies describe the way that statistical areas fit together to form groupings by location, beginning with the smallest statistical area a meshblock.  The next sized grouping is statistical area 1 (about the size of a neighbourhood block in an urban context).  The statistical area 1 aims to include between 100-500 residents  Statistical area 1 can then be aggregated into three different groupings:  statistical area 2, statistical area 3, and regional council.  Statistical area 2 aims to include around 1,000-4,000 residents and can be likened to a small suburb in an urban context, but may include a larger geographic area in rural contexts.  Statistical area 3 aims to include around ,5000 to 10,000 residents and can be likened to a major suburb in an urban context, an urban population within a sparsely populated geographic location (e.g. Alexandra), or a group of small urban areas with less than 5,000 residents etc.  Geographies defined by Regional Council comprise groupings of statistical area 1 blocks.  Territorial authorities comprise groupings of either statistical area 2 or statistical area 3 blocks and thus, indirectly, of statistical area 1 blocks.

In order to represent aggregations of census data at these levels this research retrieved concordance data from the Aria classification management system, including:

  - [Statistical Area 1 to Statistical Area 2 2023](https://aria.stats.govt.nz/aria/#ConcordanceView:uri=http://stats.govt.nz/cms/ConcordanceVersion/JxtI2hDKkMODwN1U)
  - [Statistical Area 1 to Statistical Area 3 2023](https://aria.stats.govt.nz/aria/#ConcordanceView:uri=http://stats.govt.nz/cms/ConcordanceVersion/nC0BBUXrbjn6exsh)
  - [Statistical Area 1 to Territorial Authority 2023](https://aria.stats.govt.nz/aria/#ConcordanceView:uri=http://stats.govt.nz/cms/ConcordanceVersion/rosoyMbii211crP0)
  - [Statistical Area 1 to Regional Council 2023](https://aria.stats.govt.nz/aria/#ConcordanceView:uri=http://stats.govt.nz/cms/ConcordanceVersion/oui0H1okeUvIdg9P)
 
These data tables are downloaded to csv files, imported, stripped of unnecessary data and then merged to form a single table that maps each statistical area 1 to its corresponding statistical areas 2 and 3, territorial authority, and regional authority.  The resulting table has around 33,000 rows with 7 columns


### Geographic information

Geographic information consists of shapefiles that define the boundaries of geographic areas (e.g. statistical area 1, statistical area 2, territorial authority etc.) and can be used to show display those areas on a map.  Geographic information was downloaded from the [Stats NZ Geographic Data Service](https://datafinder.stats.govt.nz/), and include shapefiles for:  

  - statistical area 1
  - statistical area 2
  - statistical area 3
  - territorial authority, and
  - regional council
  
Each download includes additional metadata and supporting documentation, but the key shapefile information is contained in the .shp file.  Geographic information is linked to the associated geographic area by either the area's code or full text name and is keyed to the "SA1" column, allowing for aggregation of statistical area 1 data across the different layers of the hierarchy.

## Describe and fit the models ( (YM), (YR), (YM, YR))

__POISSON REGRESSION ASSUMPTIONS__
  
  - POISSON RESPONSE - response variable is a count per unit of time or space, described by a poisson distribution
  - Independence - observations must be independent of one another
  - Mean = Variance
  - Linearity+ the log of the mean rate, $\log(\lambda)$ must be a linear function of x


The census data comprises count data that is collected from areas that are consistent over time (in the sense that at each census, previous years' results are rebased according to the current year's geographic boundaries).



have similar sized populations


## Describe regional proportions (totals by year, then proportion that are studying, then the same by region)

Because the census data is a snapshot of the national picture, analysis by region allows for a more granular appreciation of the data.  The data is naturally grouped by StatsNZ geographic groupings (from highest to lowest aggregations) by Regional Council, then Territorial Authority, Statistical Area 3, Statistical Area 2, and Statistical Area 1.  Initial analysis is conducted by 17 regions (including Area outside of region), with more granular analysis conducted based on subsequent 'natural' groupings, as identified during the analysis (e.g. regions with highest totals etc.)

## Describe key modes of travel by year (YM)

The census data provides responses for 2018 and 2023 so some analysis is conducted to determine any differences between years.  Travel differences between years is initially conducted at the national level and subsequently at geographical groupings and for different modes of travel. 

## Describe key regions by year (YR)  

StatsNZ divides the country into 17 regions, each of which are aggregations of smaller geographies.  Data will be analysed by region, noting changes between census year.  This analysis ignores consideration of modes of transport and focuses only on comparing total responses between years, across regions.

## Describe differences in region*mode (YM, YR)

In describing differences in Region and Mode, the analysis considers both the individual effect of region and mode of travel, as well as the interaction of those two variables.  

## Visualise regions with the biggest mode change

While statistical modelling may be helpful, many of the relationships described thus far will be presented as simple bar or column plots.  Similar analysis is conducted for regions with the biggest changes in either mode of travel or total proportions.




## Statistical modelling - generalised linear models  

The census is meant to count responses from every person in New Zealand on census night.  The primary dependent variable for our analysis is the value, or count of times a particular response was given.  The explanatory variables for the Travel to education analysis are 'Year' (Year of census), 'Region' (Geographic region), and 'Mode' (main means of travel to education).   
This analysis includes the use of generalised linear modelling (GLM) to fit the data and identify key statistical relationships.  In general, the dependent variable is the observed value ('Value'), representing a count of positive responses in the explanatory variable (i.e. 'Variable', 'Year', and location (initially 'SA1')).  We will consider models with increasing complexity as follows:  

  - the model that considers mutual independence between year, mode of travel, and region
  - the model that considers joint independence 
  - the model that considers conditional independence


__SORT THE MODELS FIRST - RESTRUCTURE THE DATA__

We will fit the census data against several models using Poisson LogLinear Generalised Linear Modelling.  The three models of interest will look for association between Year and Mode of transport (YM), Year and Region (YR), and 

Since the census data is a collection of counts, we will use the Poisson Loglinear GLM.  

  - totals by year, mode of travel, and region, without interaction.  The model is:

$$\log \mu_{ijk} = \lambda + \lambda^X_i + \lambda^Y_j + \lambda^Z_k$$
where:

  - $i$ is the year of census response (2018, 2023) 
  - $j$ represents the __mode of travel__: ( `r paste(cat(unique(teu$Variable), sep = "; "))` ) and 
  - $k$ indicates the __region__: ( `r paste(cat(unique(teu$Regional.Council), sep = "; "))`  )





  - totals by year, mode of travel, and region with two-factor interactions.  The model is:

$$\log \mu_{ij} = \lambda + \lambda^X_i + \lambda^Y_j + \lambda^{XY}_{ij}$$

  - totals by year, mode of travel, across regions

$$\log \mu_{ijk} = \lambda + \lambda^X_i + \lambda^Y_j + \lambda^{XY}_{ij} 
+ \lambda^{XZ}_{ik} + \lambda^{YZ}_{jk} + \lambda^{XYZ}_{ijk}$$





  - Visual analysis
  - Statistical analysis
  - Geographic analysis



## Geographies  

This exploratory analysis considers data at a national, regional and territorial level as defined by Statistics New Zealand (StatsNZ^[Stats NZ (2023). Statistical standard for geographic areas 2023 (updated December 2023). Retrieved from www.stats.govt.nz.]), using [geographic hierarchies](https://www.stats.govt.nz/assets/Methods/Statistical-standard-for-geographic-areas-2023/statistical-standard-for-geographic-areas-2023-updated-december-2023.pdf):  

  - Statistical Area 1 (around 100-500 households, averaging around 200, e.g. a 'block' in urban areas)
  - Statistical Area 2 (aims to reflect communities that interact socially and economically, e.g. may have a shared road network, shared community facilities, shared historical or social links etc. Analagous to a suburb (in urban areas))
  - Statistical Area 3 (aggregation larger than SA2, but smaller than a territorial authority. Analagous to large suburb in urban areas, aggregation of smaller suburbs, mix of SA2 areas acros urban and rural)
  - Territorial Authority
  - Regional Authority
  
The StatsNZ website provides data at a range of aggregations and the census data used in this analysis is summarised at the level of Statistical Area 1.  Geographic aggregations (by Territorial or Regional Authority) comprise the Statistical Area 1 groups within each level.
  
  


# Analysis  

## Statistical modelling


Fit multiple models based on the count of responses for different explanatory categories. 

```{r fn_glm_by_region}
# fit a range of models to see how we go

# run lots of models and store the results
# use a function and a for-loop:
# from census or teu table; for each unique Region; do fit a glm model from the filtered dataset
# store the model ID, reference, summary results (coefficients, deviance, GoF)

# function to run glm within a geographic region and collect results
glm_by_region <- function(data, region = NULL){
  territories <-unique(data$Territorial.Authority[data$Regional.Council == region])
  
  output <- list(region=region,
                 territory = list())
  print(output)
  for (i in 1:length(territories)){
    
    # skip Territorial authorities with only one SA3
    if (length(unique(data$SA3_chx[data$Territorial.Authority==territories[i]])) >1){
      
      df <- data[data$Territorial.Authority==territories[i], ]
     
      fit <- glm(Value~Variable*SA3_chx,
                 data = df,
                 family = 'poisson')
      
      t_name = territories[i]
      out <- list(loc = list(
        id = territories[i],
                  results = list(
                  coeffs = fit$coefficients,
                  deviance = fit$deviance,
                  Gof_pval = 1-pchisq(fit$deviance, fit$df.residual))))
      
      output$territory <- append(output$territory, out)
    }
  }
  return(output)
}


```


```{r ModelRegions}
# to access data for third terriotry: result$territory[[3]]$results
# testing <- glm_by_region(teu, region = "Bay of Plenty Region")



# consider not creating new objects, just filter existing
# dataset for model that summarises data at Regional level
# teu_reg <- teu %>%
#   group_by(Year, shortCode, Region, Variable) %>%
#   summarise(count = sum(Value))




# fit models as required
# # model with count~Region
# teu_R <- glm(count~Region,
#                       data = teu_reg,
#                       family = 'poisson')
# summary(teu_R)
# exp(coef(teu_R))
# 1-pchisq(teu_R$deviance, teu_R$df.residual)
# 
# # (VR)# teu_reg_VarAsY(VR)
# fit_teu_reg_VR <- glm(count ~ Variable * Region,
#     data = teu_reg,
#     family = 'poisson')
# summary(fit_teu_reg_VR)
# 1-pchisq(fit_teu_reg_VR$deviance, fit_teu_reg_VR$df.residual)
# # pval = 0
# 
# # (YV, YR)
# fit_teu_reg_Yv_YR <- glm(count ~ Year * Variable + Year * Region,
#     data = teu_reg,
#     family = 'poisson')
# summary(fit_teu_reg_Yv_YR)
# 1-pchisq(fit_teu_reg_YV_YR$deviance, fit_teu_reg_Yv_YR$df.residual)
# # pval = 0
# 
# # saturated model
# fit_teu_reg_YVR <- glm(count ~ Year * Variable* Region,
#     data = teu_reg,
#     family = 'poisson')
# summary(fit_teu_reg_YVR)
# 1-pchisq(fit_teu_reg_YVR$deviance, fit_teu_reg_YVR$df.residual)
# # pval = 0



# # fit logistic model that considers interaction effect RV
# fit_teu_YV_YR_RV <- glm(Value~factor(Year):Variable + factor(Year):Region + Region:Variable,
#               data = teu,
#               family = 'poisson')
# summary(fit_teu_YV_YR_RV)
# # check model fit
# # H0: (YV, YR, RV) fits the data well, H1: not H0
# # Test statistic is deviance
# pval_YV_YR_RV <- 1-pchisq(fit_teu_YV_YR_RV$deviance, fit_teu_YV_YR_RV$df.residual)
# # pval =0 < alpha=0.05 so reject null, model is not a good fit
# 
# 
# # check the model with year and interaction by Region:Variable
# teu_Y_RV <- glm(Value~factor(Year)+Region*Variable,
#                 data = teu,
#                 family = 'poisson')
# summary(teu_Y_RV)
# # check model fit
# # H0: (Y, RV) fits the data well, H1: not H0
# # Test statistic is deviance
# pval_Y_RV <- 1-pchisq(teu_Y_RV$deviance, teu_Y_RV$df.residual)
# # pval = 0
# 
# 
# # fit logistic model that considers interaction effect YV for Auckland
# teu_YV_ak <- glm(Value ~factor(Year)*Variable,
#               data = teu[teu$Region=="Auckland",], 
#               family = 'poisson')
# summary(teu_YV_ak)
# # check model fit
# # H0: (Y, RV) fits the data well, H1: not H0
# # Test statistic is deviance
# pval_YV_ak <- 1-pchisq(teu_YV_ak$deviance, teu_YV_ak$df.residual)
# # pval = 0, reject null, model does not fit the data
# 
# 
# # fit logistic model that considers Passenger by Year and Region
# teu_YR_pax <- glm(Value ~factor(Year)*Region,
#                    data = teu[teu$Variable=="Passenger in a car, truck or van",],
#                    family = 'poisson')
# summary(teu_YR_pax)
# 
# 
# # fit logistic model that considers passenger by Region
# teu_R_pax <- glm(Value ~ Region,
#                  data = teu[teu$Variable=="Passenger in a car, truck or van", ],
#                  family = 'poisson')
# summary(teu_R_pax)
# 1-pchisq(teu_R_pax$deviance, teu_R_pax$df.residual)
# # pval = 0, not a good fit
# 
# ### this model is way too big
# # # fit a model that considers SA3 within a region (Auckland)
# # teu_VSA3_R_ak <- glm(Value ~ Variable*SA3_chx,
# #                     data = teu[teu$Region=="Auckland", ],
# #                     family = 'poisson')
# # summary(teu_VSA3_R_ak)
# # 1-pchisq(teu_VSA3_R_ak$deviance, teu_VSA3_R_ak)
# # # pval =  , 

```



Trying to fit the data to models is a bit... fraught.  Modelling for main effects of Year, Region, Variable at a national level result in models that don't fit the data.  Modelling for interaction effects between paris of Year, Region and Variable also result in models that fit the data poorly at the national level.  Modelling the interaction of Year and Region for a specific mode of travel ("passenger in a car, truck, or van") results in a model with poor fit...

Try smaller models that look by territorial authority within region and then by SA2 (suburb) within SA3 

```{r teuModelsByRegion}
# # fit a bunch of models as part of a for loop
# for (sa3 in unique(teu$SA3_chx[teu$Region=="Bay of Plenty"])){
#   fit_bop <- glm(Value ~ Year*TravelMode,
#                  data = teu[teu$SA3_chx==sa3,],
#                  family = 'poisson')
#   paste(cat("********** Summary for ", sa3, " ************"))
#   print(summary(fit_bop))
#   print(1-pchisq(fit_bop$deviance, fit_bop$df.residual))
# }
```



National level results for total proportions of travel to education by mode of travel, based on address of usual residence.

Create a function to break down each regional council into territorial authorities
Then territorial authorities into SA3
then SA3 into SA2

look at variables like:  

  - income bracket (ib)
  - number of cars 
  - 



## Analysing data using plots

### National level analysis - Totals by year, region, and mode of travel  

Visual analysis of data begins at highest level, with totals by year, region, and mode of travel.

```{r fnBaseAndYearPlots}

# create function to generate base and year level breakdowns of means of travel,
# combining multiple regions
base_year_plots <- function(df_base, df_year, reg){

  # base level plot for no year breakdown
  baseplot <- ggplot(df_base %>% filter(Regional.Council %in% reg),
                  aes(x = TravelMode))+
    scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) +
    coord_flip()
  
  # base level plot for all regions
  yearplot <- ggplot(df_year %>% filter(Regional.Council %in% reg),
                  aes(x = TravelMode, y = Value, fill = factor(Year)), 
                  group = Region)+
    scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) 
  
  # plot  
  bp <- baseplot + geom_col(aes(y = Value))+
    labs(title = "Total counts for travel to education by mode of travel") 
  
  yp <-yearplot + geom_bar(position = 'dodge', stat = 'summary', fun =sum)+ 
    labs(title = "Total counts for travel to education by mode of travel and year")+
    coord_flip()  
  
  return(list(bp = bp, yp = yp))
  
}

```

```{r subsetTEUbyYear}
#structure data for plotting by year
teu_year <- teu %>%
  group_by(TravelMode, Year, Regional.Council) %>%
  summarise(Value = sum(Value))
```


```{r teuModeNational, include = TRUE, echo=FALSE, message = FALSE, fig.show="hold", out.width="50%", fig.cap='Travel to education: summary plots'}
# plot 3 levels of analysis across 2 columns
par(mfrow = c(3, 2))

# all regions
regAll <- unique(teu$Regional.Council)



# base level plot for no year breakdown
baseplot <- ggplot(teu)+
  scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) +
  coord_flip()

# base level plot for selected regions
yearplot <- ggplot(teu_year, aes(y = Value), group = factor(Year))+
  scale_y_continuous(labels = function(x) format(x, scientific = FALSE))+
  coord_flip()


### totals for all regions
# plot totals by year
ggplot(data= teu, aes(x = factor(Year), y = Value)) +  
  geom_col() +
  labs(title = "Total counts for travel to education, 2018 and 2023")+
  xlab("Census year")+
  scale_y_continuous(labels = function(x) format(x, scientific = FALSE))

# plot totals by year and mode
ggplot(teu, aes(x = factor(Year), y = Value, fill = TravelMode))+
  geom_col()+
  scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) +
  scale_x_discrete(guide = guide_axis(n.dodge = 3)) +
  labs(title = "Total counts for travel to education by year and travel mode")


# plot totals by region
baseplot +
  geom_col(aes(x = Regional.Council, y = Value)) +
  labs(title = "Total counts for travel to education, 2018 and 2023")
yearplot +
  geom_bar(aes(x = Regional.Council, fill = factor(Year)), 
           position = 'dodge',
           stat = 'summary',
           fun = sum)+
  labs(title = "Total counts for travel to education by region")


# plot of modes for all regions
allRegions <-base_year_plots(teu, teu_year, regAll)
allRegions$bp
allRegions$yp
rm(allRegions)

# # plot totals by travel mode
# baseplot +
#   geom_col(aes(x = TravelMode, y = Value, fill = factor(Year))) +
#   labs(title = "Total counts for travel to education by mode of travel")
# 
# yearplot +
#   geom_col(aes(x = TravelMode, y = Value, fill = factor(Year)),
#            position = 'dodge') +
#   labs(title = "Total counts for travel to education by mode of travel and year")

# return to 1x1
par(mfrow = c(1, 1))
```

Total counts for the travel to education segment are higher in 2023 than 2018, with 'passenger in car, truck, van' as the most reported mode of travel, followed by 'walk or jog', 'drive car, truck, van', 'school bus',  and 'studying at home'.  In comparing regions, 'Auckland' has, by far the highest reports of travel to education over across both census years, followed by 'Canterbury', 'Wellington', then 'Bay of Plenty'.

There are four natural groupings based on similar totals:  

  - Auckland
  - Canterbury, Wellington, Waikato
  - Bay of Plenty, Otago, Manawatu-Whanganui, Hawke's Bay, Northland
  - Taranaki, Southland, Gisborne, Marlborough, Nelson, Tasman, West Coast

The Auckland region has only one division by Territorial Authority ("Auckland"), which has nearly 200 areas at Statistical Area 3.  

### Regional level analysis:  Auckland  

[THIS SECTION WILL BE MASSIVE, NEEDS TO BE REDUCED INTO GROUPINGS]

```{r Auckland, include = TRUE, echo = FALSE, fig.show='hold', out.width="50%", fig.cap = 'Combined main means of travel to education for Auckland'}
# plots to compare totals within regions, then compare modes by region and year
par(mfrow=c(1,2))

# set regional filter to 'Auckland
reg1 <- "Auckland Region"
akld <- base_year_plots(teu, teu_year, reg1)
akld$bp
akld$yp
rm(akld)

par(mfrow=c(1,1))
```


```{r nextRegions, include = TRUE, echo = FALSE, fig.show='hold', out.width="50%", fig.cap = 'Combined main means of travel to education for Auckland'}
# 
# # regions in region 2
# reg <- c('Auckland')
# 
# # base level plot for no year breakdown
# baseplot <- ggplot(teu %>% filter(Region %in% reg),
#                 aes(x = TravelMode))+
#   scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) +
#   coord_flip()
# 
# # base level plot for all regions
# yearplot <- ggplot(teu_year %>% filter(Region %in% reg),
#                 aes(x = TravelMode, y = Value, fill = factor(Year)), 
#                 group = Region)+
#   scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) 
# 
# 
# # plot  
# baseplot + geom_col(aes(y = Value))+
#   labs(title = "Total counts for travel to education by mode of travel") 
# 
# yearplot + geom_bar(position = 'dodge', stat = 'summary', fun =sum)+ 
#   labs(title = "Total counts for travel to education by mode of travel and year")+
#   coord_flip()


```

For all three regions (Canterbury, Wellington, and Waikato), the main means of travel to education is as a 'passenger in a car, van, or truck', followed by 'Walk or jog', 'drive a car, van, or truck', 'school bus', 'public bus', 'studying from home' and then 'bicycle'.  A small proportion travel by 'train', or 'other'.  When broken down by census year and going from 2018 to 2023, there were increases in travelling as a passenger, studying from home, driving, using a bicycle, and using a public bus.  Over the same time period, these three regions had overall decreases in walking, and small decreases in using school bus or train to get to education. 

```{r fn_by_facet}
# create a function to generate modes of travel plots wrapped by region
by_facet <- function(df_year, reg, nr=1, nc=1){
  
  # year level level plot for all regions
  yearplot <- ggplot(df_year %>% filter(Regional.Council %in% reg),
                  aes(x = TravelMode, y = Value, fill = factor(Year)), 
                  group = Regional.Council)+
    scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) 
  
  yearplot + geom_bar(position = 'dodge', stat = 'summary', fun =sum)+
  labs(title = "Total counts for travel to education by mode of travel and year") +
  scale_x_discrete(guide = guide_axis(n.dodge = 3))+
  facet_wrap(~Regional.Council, nrow = nr, ncol = nc)
}
```


```{r facet_Auckland, include = TRUE, echo = FALSE, fig.cap = 'Main means of travel to education for Auckland'}
by_facet(teu_year, reg1)
# # facet wrap by region
# yearplot + geom_bar(position = 'dodge', stat = 'summary', fun =sum)+
#   labs(title = "Total counts for travel to education by mode of travel and year") +
#   scale_x_discrete(guide = guide_axis(n.dodge = 3))+
#   facet_wrap(~Region, nrow = length(reg))
```


### Regional level analysis:  Canterbury, Wellington, Waikato  

Initial analysis comparing relative modes of transport between regions Canterbury, Wellington, and Waikato using high-level summary plots.

```{r CanterburyWellingtonWaikato, include = TRUE, echo = FALSE, fig.show='hold', out.width="50%", fig.cap = 'Combined main means of travel to education for Canterbury, Wellington and Waikato'}
# plots to compare totals within regions, then compare modes by region and year
par(mfrow=c(1,2))

# regions in region 2
reg2 <- c("Canterbury Region", "Wellington Region", "Waikato Region")
cww <- base_year_plots(teu, teu_year, reg2)

cww$bp
cww$yp
rm(cww)

# # base level plot for no year breakdown
# baseplot <- ggplot(teu %>% filter(Region %in% reg),
#                 aes(x = TravelMode))+
#   scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) +
#   coord_flip()
# 
# # base level plot for all regions
# yearplot <- ggplot(teu_year %>% filter(Region %in% reg),
#                 aes(x = TravelMode, y = Value, fill = factor(Year)), 
#                 group = Region)+
#   scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) 
# 
# 
# # plot  
# baseplot + geom_col(aes(y = Value))+
#   labs(title = "Total counts for travel to education by mode of travel") 
# 
# yearplot + geom_bar(position = 'dodge', stat = 'summary', fun =sum)+ 
#   labs(title = "Total counts for travel to education by mode of travel and year")+
#   coord_flip()

par(mfrow=c(1,1))
```

For all three regions (Canterbury, Wellington, and Waikato), the main means of travel to education is as a 'passenger in a car, van, or truck', followed by 'Walk or jog', 'drive a car, van, or truck', 'school bus', 'public bus', 'studying from home' and then 'bicycle'.  A small proportion travel by 'train', or 'other'.  When broken down by census year and going from 2018 to 2023, there were increases in travelling as a passenger, studying from home, driving, using a bicycle, and using a public bus.  Over the same time period, these three regions had overall decreases in walking, and small decreases in using school bus or train to get to education. 

```{r facetCanterburyWellingtonWaikato, include = TRUE, echo = FALSE, fig.cap = 'Main means of travel to education for Canterbury, Wellington and Waikato'}
# facet wrap by region
by_facet(teu_year, reg2, nr = 3, nc = 1)

# yearplot + geom_bar(position = 'dodge', stat = 'summary', fun =sum)+
#   labs(title = "Total counts for travel to education by mode of travel and year") +
#   scale_x_discrete(guide = guide_axis(n.dodge = 3))+
#   facet_wrap(~Region, nrow = length(reg))
```

Comparing between regions Canterbury and Waikato saw an increase in travelling to education as a passenger, with Wellington fairly stable on the same mode.  All three regions saw an increase in study at home, with decreases in walking for Wellington and Waikato.  Canterbury reported more travel by bicycle than both waikato and Wellington.  In each region, passenger was the most common means of travel to education, followed by walking, then driving in Canterbury and Waikato.  Wellington's third highest mode was public bus, followed by an even standing between school bus and driving. Travelling on a school bus was within the top four modes for all three regions.

### Regional level analysis:  Bay of Plenty, Otago, Manawatu-Whanganui, Hawke's Bay, Northland  

Initial analysis comparing relative modes of transport between regions Bay of Plenty, Otago, Manawatu-Whanganui, Hawke's Bay and Northland, using high-level summary plots.

```{r BOPOtagoManawatuHawkewBayNorthland, include = TRUE, echo = FALSE, fig.show='hold', out.width="50%", fig.cap = "Combined main means of travel to education for Bay of Plenty, Otago, Manawatu-Whanganui, Hawke's Bay, and Northland"}
# plots to compare totals within regions, then compare modes by region and year
par(mfrow=c(1,2))

# regions in region 2
reg3 <- c("Bay of Plenty Region", "Otago Region", "Manawatu-Whanganui Region", "Hawke's Bay Region", "Northland Region")

bmhn <- base_year_plots(teu, teu_year, reg3)
bmhn$bp
bmhn$yp
rm(bmhn)

# # base level plot for no year breakdown
# baseplot <- ggplot(teu %>% filter(Region %in% reg),
#                 aes(x = TravelMode))+
#   scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) +
#   coord_flip()
# 
# # base level plot for all regions
# yearplot <- ggplot(teu_year %>% filter(Region %in% reg),
#                 aes(x = TravelMode, y = Value, fill = factor(Year)), group = Region)+
#   scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) 
# 
# 
# # compare base to breakdown by year 
# baseplot + geom_col(aes(y = Value))+
#   labs(title = "Total counts for travel to education by mode of travel")
# 
# yearplot + geom_bar(position = 'dodge', stat = 'summary', fun =sum) +
#   labs(title = "Total counts for travel to education by mode of travel and year") +
#   coord_flip()

par(mfrow=c(1,1))
```

Combined results for both census years and all seven regions in this group show the predominant means of travel to education is 'passenger in car, truck or van', followed by 'walk or jog', then 'school bus', 'drive a car, truck or van', 'study at home', 'bicycle', 'public bus', 'other'.  Comparing results between the 2018 and 2023, saw an increase in 'passenger', 'study at home', and a slight increase in travel by 'school bus'.  Decreasing means of travel for this regional group were 'walk or jog', with smaller decreases for 'drive a car, truck or van', 'bicycle', and 'other'.

```{r facetBOPOtagoManawatuHawkesBayNorthland, include = TRUE, echo = FALSE, out.width = "100%", fig.cap="Main means of travel by region: Bay of Plenty, Otago, Manawatu-Whanganui, Hawke's Bay, Northland"}
# facet wrap by region
by_facet(teu_year, reg3, nr=3, nc=2)

# yearplot + geom_bar(position = 'dodge', stat = 'summary', fun =sum)+
#   labs(title = "Total counts for travel to education by mode of travel and year") +
#   facet_wrap(~Region, nrow = 3, ncol = 2) + 
#   scale_x_discrete(guide = guide_axis(n.dodge = 3))+ 
#   theme(legend.position = 'inside', legend.position.inside = c(0.8, 0.05))
```

Comparing across all regions, 'passenger in a car, truck or van' is the predominant means of travel to education.  'Walk or jog' occurs at a similar level in Otago, is the second highest in Manawatu-Whanganui, and is with the top three means of travel for all regions.  In both Bay of Plenty and Northland, the second highest means of transport is 'school bus'.  For all regions, 'drive a car, truck or van' is more commonly the main means of travel, with similar counts as the 2023 'study at home' category, which itself increased across all regions in this group between 2018 and 2023.


### Regional level analysis:  Taranaki, Southland, Gisborne, Marlborough, Nelson, Tasman, West Coast  

Initial analysis comparing relative modes of transport between regions Taranaki, Southland, Gisborne, Marlborough, Nelson, Tasman, and West Coast.

```{r TaranakiSthlndGisbMarlNelsTasmWestC, include = TRUE, echo = FALSE, fig.show='hold', out.width="50%", fig.cap = "Combined main means of travel to education for Taranaki, Southland, Gisborne, Marlborough, Nelson, Tasman, and West Coast"}
# plots to compare totals within regions, then compare modes by region and year
par(mfrow=c(1,2))

# regions in region 2
reg4 <- c("Taranaki Region", "Southland Region", "Gisborne Region", 
          "Marlborough Region", "Nelson Region", "Tasman Region", "West Coast Region" )

rest <- base_year_plots(teu, teu_year, reg4)
rest$bp
rest$yp
rm(rest)


# # base level plot for no year breakdown
# baseplot <- ggplot(teu %>% filter(Region %in% reg),
#                 aes(x = TravelMode))+
#   scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) +
#   coord_flip()
# 
# # base level plot for all regions
# yearplot <- ggplot(teu_year %>% filter(Region %in% reg),
#                 aes(x = TravelMode, y = Value, fill = factor(Year)), group = Region)+
#   scale_y_continuous(labels = function(x) format(x, scientific = FALSE)) 
# 
#   
# baseplot + geom_col(aes(y = Value))+
#   labs(title = "Total counts for travel to education by mode of travel")
# 
# yearplot + geom_bar(position = 'dodge', stat = 'summary', fun =sum)+
#   labs(title = "Total counts for travel to education by mode of travel and year") +
#   coord_flip()

par(mfrow=c(1,1))
```

Combined totals for the regions Taranaki, Southland, Gisborne, Marlborough, Nelson, Tasman and West Coast show the main means of travel to education as 'passenger in car, truck or van', followed by 'walk or jog', 'school bus', 'drive car, truck or van', 'study at home', 'bicycle', 'public bus', and 'other'.  There is a very small proportion of response that travel to education by 'train' and by 'ferry'.  Comparing differences between census years 2018 and 2023 across all regions in this group shows increases in 'passenger' and 'study at home', and a decrease in 'walk or jog' for the later census.  Other means of travel are stable between census years.

```{r facetTaranakiSthlndGisbMarlNelsTasmWestC, include = TRUE, echo = FALSE, out.width = "100%", fig.cap="Main means of travel by region: Taranaki, Southland, Gisborne, Marlborough, Nelson, Tasman, and West Coast"}
# facet wrap by region

by_facet(teu_year, reg4, nr = 4, nc = 2)
# yearplot + geom_bar(position = 'dodge', stat = 'summary', fun =sum)+
#   labs(title = "Total counts for travel to education by mode of travel and year") +
#   facet_wrap(~Region, nrow = 4, ncol = 2) + 
#   scale_x_discrete(guide = guide_axis(n.dodge = 3))+ 
#   theme(legend.position = 'inside', legend.position.inside = c(0.8, 0.1))
```
Comparing modes of travel between the regions in this group shows that the main means of travel to education is 'passenger in car, truck or van', with highest totals in Taranaki, then Southland and Gisborne.  Nelson, Marlborough, and Tasman have similar counts of 'passenger', with the lowest counts overall for West Coast.  Taranaki, Southland, and Gisborne's top three means of travel are 'passenger', 'walk', and 'school bus'.  Between 2018 and 2023, all regions except Nelson saw an increase in counts for 'passenger'.  

### Summary of high-level plots  

  - The most common main means of travel to education across all regions and both years is 'passenger in car, truck or van' with increases from 2018 to 2023 for all regions except Nelson
  - The second most common main means of travel is either 'walk or jog' (Canterbury, Wellington, Waikato, Otago, Manawatu-Whanganui, Hawke's Bay, Taranaki, Nelson, and Marlborough), or 'school bus' (Gisborne, West Coast, Tasman, Southland, Northland)
  - 

## Plotting data by geographies

### Regional groupings:  Auckland




### Regional groupings:  Canterbury, Waikato, and Wellington

Overlay count data on to geographies for Canterbury, Waikato, and Wellington.

```{r regionalShapefiles, }
# read in the regional shape file and filter to just the identifiers and geometry
# read once, keep it out of the function
r_shp <- st_read(shp_rc, quiet = TRUE)%>% 
  select(c(1, 2, geometry)) %>%
  rename(RC = 1,
         Regional.Council = 2)
# get regional bounding boxes
# eg.   rbb <- getbb("Auckland Region) --> returns min/max x= long, y = lat

# select regions into target groups, although this may be a bad idea when they are distal
# can use existing reg1, reg2, reg3, reg4 for groupings

# rc1 <- "Auckland Region"
# rc2 <- c("Canterbury Region", "Wellington Region", "Waikato Region")
# rc3 <- c("Bay of Plenty Region", "Otago Region", "Manawatu-Whanganui Region",
#          "Hawke's Bay Region", "Northland Region")
# rc4 <- c("Taranaki Region", "Southland Region", "Gisborne Region",
#          "Marlborough Region", "Nelson Region", "Tasman Region",
#          "West Coast Region")
```


```{r fnSaInBigger, include = TRUE, fig.cap="Testing the function's output"}
######## function ##############
# small shapes in bigger ones
sa_in_bigger <- function(df, reg){
  
  # read in the sa3 shape file and filter to just the identifiers and geometry
  shapefiles <- st_read(shp_sa3, quiet = TRUE) %>%
    select( c(1, 2, geometry)) %>%
    rename(SA3 = 1,
           SA3_chx = 2) %>%
    filter(SA3_chx %in% unique(df$SA3_chx[df$Regional.Council %in% reg]))
  
  # summarise data to sa3, retain year, region, sa3, and mode of travel
  sa3_df <- df %>% 
    filter(Regional.Council %in% reg) %>%
    group_by(Year, Regional.Council, SA3_chx, TravelMode, Value) %>%
    summarise(Value = sum(Value))
  
  # this creates a plot of the whole country with region shapes
  plt <- ggplot(data = sa3_df %>% 
           filter(Regional.Council %in% reg) %>% 
           group_by(Year, Regional.Council, TravelMode) %>% 
           summarise(total = sum(Value)),
         )+
    geom_sf(data = st_geometry(r_shp %>% filter(Regional.Council %in% reg)),
            fill = 'white') + 
    geom_sf(data = st_geometry(shapefiles), 
            fill = 'blue') + #sa3_df$SA3_chx) + #figure out a way to get filled
    labs(main = paste("Regional breakdown of main means of travel to education"))
  return(list(plot = plt))
}

###########################
# test with 'Bay of Plenty Region'
sa_in_bigger(teu, 'Bay of Plenty Region')$plot

```

```{r pointsWithMaps, include = TRUE}
# try the demo from:
# https://bookdown.org/fede_gazzelloni/UPDVwR/mapchallenges/cases2023/posts2023/day1_points/day1_points.html

library(tidyverse)
library(stars)

# # reshape dataset (wider) and summarise
# mini_df <- census %>%
#   filter(shortCode %in% 'teu') %>%
#   pivot_wider(values_from = Value,
#               values_fn = sum,
#               names_from = Variable,
#               id_cols = c(Year, Regional.Council))

# summarise dataset
mini_df <- census %>%
  filter(shortCode %in% 'teu') %>%
  group_by(Year, Regional.Council, SA3_chx, Variable) %>%
  summarise(Value = sum(Value))

# retrieve schools dataset from data.govt.nz, there are around 2500 schools, 
# so limit to 3000

qry <- paste('https://catalogue.data.govt.nz/api/3/action/datastore_search?resource_id=4b292323-9fcc-41f8-814b-3c7b19cf14b3&limit=3000')
schools <- httr::GET(qry) 
school_data <- fromJSON(rawToChar(schools$content))$result$records %>%
  select(School_Id, Org_Name, Territorial_Authority, Regional_Council, 
         Statistical_Area_2_Code, Statistical_Area_2_Description, 
         Latitude, Longitude, Total, Isolation_Index)




# ... actually, try this leaflet version instead
# https://bookdown.org/fede_gazzelloni/UPDVwR/mapchallenges/cases2023/posts2023/day7_navigation/day7_navigation.html
library(tidyverse)
library(leaflet)
library(viridisLite)

mini_df %>% glimpse

# set colour palette
colPalette <- leaflet::colorFactor("viridis", 
                                   domain = factor(mini_df$Regional.Council))

# retrieve shapefile centroids
rc_centres <- st_centroid(r_shp, quiet = TRUE) %>%
  dplyr::mutate(lon = sf::st_coordinates(.)[,2],
                lat = sf::st_coordinates(.)[,1])

# get bounding box and then modify to jump the antimeridian
rc_bounds <- (getbb("New Zealand") + c(360, 90)) %% c(360)-c(0, 90)

leaflet(mini_df) %>%
  setView(175.5, -41, zoom =5) %>%
  addTiles() %>%
  addTiles(group = "OSM (default)") %>%
  addProviderTiles(providers$OpenStreetMap) %>%
  addCircleMarkers(lng = ~school_data$Longitude,
             lat = ~school_data$Latitude,
             fill = TRUE,
             stroke = TRUE,
             color = colPalette(school_data$Regional_Council),
             weight = 1,
             fillOpacity = 0.2,
             popup = ~school_data$Org_Name) %>%
  addMiniMap() %>%
  mapOptions() %>%
  addMeasure() %>%
  addScaleBar()

```


```{r nzOSMExtract, include = TRUE, fig.cap='example from Data Visualization 30 day map challenge'}
# example from:  https://bookdown.org/fede_gazzelloni/UPDVwR/mapchallenges/cases2023/posts2023/day15_openstreetmap/day15_openstreetmap.html

# get bounding box for NZ
nz_bb <- osmdata::getbb('New Zealand')
library(osmextract)
nz_pbf <- osmextract::oe_match("New Zealand")
nz_download <- osmextract::oe_download(file_url = nz_pbf$url, 
                                       download_directory = getwd()
                                       )
# nz takes 1429-1431

####
# bounding box for Bay of Plenty using osmdata
bop_bb <- osmdata::getbb('Bay of Plenty')

# construct a map object focussed on just bop
bop_map <- OpenStreetMap::openmap(
  c(bop_bb['y', 'max'], bop_bb['x', 'min'] ),
  c(bop_bb['y', 'min'], bop_bb['x', 'max']),
  zoom = 10,
  minNumTiles = 9L,
  type = 'osm'
)

# use OpenStreetMap to plot the map
OpenStreetMap::plot.OpenStreetMap(bop_map)

# # retrieve features:  schools
# bop <- opq(bop_bb) %>%
#   add_osm_feature(
#     key = 'school', 
#     value = 'primary') %>%
#   osmdata_sf()
# # fails, no features retrieved
# bop
```

Query from data.govt.nz to bring back school locations for Regional_Council = Wellington Region, Territorial_Authority = Lower Hutt City

[link](https://catalogue.data.govt.nz/dataset/directory-of-educational-institutions/resource/4b292323-9fcc-41f8-814b-3c7b19cf14b3?filters=Regional_Council%3AWellington%20Region%7CRegional_Council%3ABay%20of%20Plenty%20Region%7CTerritorial_Authority%3ALower%20Hutt%20City) 


e.g first five results
https://catalogue.data.govt.nz/api/3/action/datastore_search?resource_id=4b292323-9fcc-41f8-814b-3c7b19cf14b3&limit=5 

e.g. containing 'jones'
https://catalogue.data.govt.nz/api/3/action/datastore_search?resource_id=4b292323-9fcc-41f8-814b-3c7b19cf14b3&q=jones

e.g. sql for jones
"https://catalogue.data.govt.nz/api/3/action/datastore_search_sql?sql=SELECT * from "4b292323-9fcc-41f8-814b-3c7b19cf14b3" WHERE title LIKE 'jones'"

```{r isoChroneBOP}
# use the tutorial at:
# https://cran.r-project.org/web/packages/r5r/vignettes/isochrones.html

# tutorial requires lots of memory for java, so change options before calling library
library(sf)
library(data.table)
library(ggplot2)
library(interp) 
library(tidytransit)

# get bounding box for NZ
nz_bb <- osmdata::getbb('New Zealand')
library(osmextract)
nz_pbf <- osmextract::oe_match("New Zealand")
nz_download <- osmextract::oe_download(file_url = nz_pbf$url, 
                                       download_directory = getwd()
                                       )
# nz takes 1429-1431

####
# bounding box for Bay of Plenty using osmdata
bop_bb <- osmdata::getbb('Bay of Plenty')

# construct a map object focussed on just bop
bop_map <- OpenStreetMap::openmap(
  c(bop_bb['y', 'max'], bop_bb['x', 'min'] ),
  c(bop_bb['y', 'min'], bop_bb['x', 'max']),
  zoom = 10,
  minNumTiles = 9L,
  type = 'osm'
)

# # use OpenStreetMap to plot the map
# OpenStreetMap::plot.OpenStreetMap(bop_map)


# build a routable transport network, the demo uses built in data, but let's try
# with the nzpbf from earlier from earlier, repeated here

########################

# the demo reads in points, we can subset the school_data for bop region
bop_schools <- school_data %>% filter(Regional_Council=="Bay of Plenty Region")


## isochrone parameters
# isochrone intervals
time_intervals <- seq(0, 60, 5)

# routing inputs
mode <- c('WALK', 'TRANSIT', 'CYCLE')
max_walk_time <-25  # minutes
max_trip_duration <- 60 # minutes
time_window <- 120 # minutes
departure_datetime <- as.POSIXct("12-03-2024 07:30:00",
                                 format = "%d-%m-%Y %H:%M:%S")

# not in the tutorial, but we need to bring relevant information together
# and put in a folder for r5r to search ...loading the nz_map data instead


# initialise java and then check something
rJava::.jinit()
rJava::.jcall("java.lang.System", "S", "getProperty", "java.version")


options(java.parameters = "-Xmx4G")
library(r5r)

r5r_core <- r5r::setup_r5(getwd())
#with NZ map 1434-1436
# reports multiple errors and skips


# calculate travel time matrix
iso_bop <- r5r::isochrone(r5r_core, 
                          origins = bop_schools, 
                          mode = mode, 
                          cutoff = time_intervals,
                          sample_size = 1,
                          departure_datetime = departure_datetime,
                          max_walk_time = max_walk_time,
                          max_trip_duration = max_trip_duration,
                          time_window = time_window,
                          progress = FALSE
                          )

r5r::stop_r5(r5r_core)

```

Metro canterbury GET query for GTFS
https://apis.metroinfo.co.nz/rti/gtfs/v1/gtfs.zip
Bay of Plenty GTFS
https://www.baybus.co.nz/help-and-contact/general-transit-feed-specification/
https://www.baybus.co.nz/assets/GTFS/boprc-nz-rits-6-1.zip 





